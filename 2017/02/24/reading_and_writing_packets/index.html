<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">

<script>
    (function(){
        if(''){
          // alert('此文章并不公开, 输入文章密码方可阅读');
          var password = prompt('此文章并不公开, 输入文章密码方可阅读');
          if (password !== ''){
            if (password != null) // 如果用户点击了确认而且密码错误的时候, 因为当password == null的时候说明用户点了取消
            {
              alert('Error!');
            }
            if (history.length > 1)
            {
              history.back();
            }
            else
            {
              window.location.href = "about:blank";
            }
          }
        }
    })();
</script>








<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">















  
  
  <link href="/lib/fancybox/dist/jquery.fancybox.css?v=3.2.10" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css">


  <meta name="keywords" content="GafferOnGames,">








  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.1.2">






<meta name="description" content="自我总结这篇文章只是介绍, 之后的文章才是正题. 此篇文章大体介绍了 :   文本格式传输的低效率问题， 为了可读性而产生了太多冗余无用数据 为什么不用目前已经有了的库比如Protocol Buffers：因为我们不需要版本信息，也不需要什么跨语言的支持。所以让我们直接忽略掉这些功能并用我们自己的不带属性的二进制流进行代替，在这个过程中我们可以获得更多的控制性和灵活性 要注意大小端的问题 实现一个">
<meta name="keywords" content="GafferOnGames">
<meta property="og:type" content="article">
<meta property="og:title" content="构建游戏网络协议一之数据包的读取和写入">
<meta property="og:url" content="https://hulinhong.com/2017/02/24/reading_and_writing_packets/index.html">
<meta property="og:site_name" content="烫">
<meta property="og:description" content="自我总结这篇文章只是介绍, 之后的文章才是正题. 此篇文章大体介绍了 :   文本格式传输的低效率问题， 为了可读性而产生了太多冗余无用数据 为什么不用目前已经有了的库比如Protocol Buffers：因为我们不需要版本信息，也不需要什么跨语言的支持。所以让我们直接忽略掉这些功能并用我们自己的不带属性的二进制流进行代替，在这个过程中我们可以获得更多的控制性和灵活性 要注意大小端的问题 实现一个">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2024-01-06T05:40:57.172Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="构建游戏网络协议一之数据包的读取和写入">
<meta name="twitter:description" content="自我总结这篇文章只是介绍, 之后的文章才是正题. 此篇文章大体介绍了 :   文本格式传输的低效率问题， 为了可读性而产生了太多冗余无用数据 为什么不用目前已经有了的库比如Protocol Buffers：因为我们不需要版本信息，也不需要什么跨语言的支持。所以让我们直接忽略掉这些功能并用我们自己的不带属性的二进制流进行代替，在这个过程中我们可以获得更多的控制性和灵活性 要注意大小端的问题 实现一个">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"scrollpercent":true,"onmobile":true,"dimmer":true,"body_content_height":0,"display_duration":150},
    local_search: {"enable":true,"trigger":"auto","top_n_per_article":1},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"duration":222,"transition":{"header":"slideDownIn","menu":"slideDownIn","logo":"slideDownIn","post_block_else":"slideDownIn","post_header":"fadeIn","post_body":"fadeIn","coll_header":"slideDownIn","footer":"slideDownIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>








  <title>构建游戏网络协议一之数据包的读取和写入 | 烫</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">烫</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">烫烫烫烫烫</p>
      
  </div>

  <div class="menu-item sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <div class="menu-item site-search">
    
  
  <form class="site-search-form">
    <span class="search-icon fa fa-search"></span>
    <input type="text" id="local-search-input" class="st-search-input">
    <i id="local-search-close">×</i>
  </form>


<script type="text/javascript" id="local.search.active">
var inputArea       = document.querySelector("#local-search-input");
inputArea.onclick   = function(){ getSearchFile(); this.onclick = null }
inputArea.onkeydown = function(){ if(event.keyCode == 13) return false }
</script>



  </div>
  <div id="local-search-result-pc" class="local-search-result-cls"></div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  
  

  
    <ul id="menu" class="menu menu-left">
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      

       
    </ul>
  

  
    
  
</nav>



 </div>
    </header>

    <div id="local-search-result-mobile" class="local-search-result-cls"></div>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hulinhong.com/2017/02/24/reading_and_writing_packets/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="no5ix">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="烫">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">构建游戏网络协议一之数据包的读取和写入</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-02-24T13:13:35+00:00">
                2017-02-24
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/GS/" itemprop="url" rel="index">
                    <span itemprop="name">GS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            <div class="post-tags">
              
                <a href="/tags/GafferOnGames/" rel="tag"><i class="fa fa-tag"></i> GafferOnGames</a>
              
            </div>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    




    
    
    
    <div class="post-body" itemprop="articleBody">
      
      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/02/10/kbe之ubuntu下的编译/" rel="next" title="kbe之ubuntu下的编译">
                <i class="fa fa-chevron-left"></i> 
                <p class="post-nav-pre-next-title">
                  kbe之ubuntu下的编译
                </p> 
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/02/25/serialization_strategies/" rel="prev" title="构建游戏网络协议二之序列化策略">
              <p class="post-nav-pre-next-title">
                  构建游戏网络协议二之序列化策略
              </p> 
              <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      

      
      

      
        <h1 id="自我总结"><a href="#自我总结" class="headerlink" title="自我总结"></a>自我总结</h1><p>这篇文章只是介绍, 之后的文章才是正题. 此篇文章大体介绍了 : </p>
<ul>
<li>文本格式传输的低效率问题， 为了可读性而产生了太多冗余无用数据</li>
<li>为什么不用目前已经有了的库比如Protocol Buffers：因为我们不需要版本信息，也不需要什么跨语言的支持。所以让我们直接忽略掉这些功能并用我们自己的不带属性的二进制流进行代替，在这个过程中我们可以获得更多的控制性和灵活性</li>
<li>要注意大小端的问题</li>
<li>实现一个位打包器， 工作在32位或者64位的级别， 而不是是工作在字节这个级别。因为现代机器对这个长度进行了专门的优化而不应该像1985年那样在字节的级别对缓冲区进行处理。</li>
<li>要注意防止恶意数据包的问题 ：<ul>
<li>我们需要实现一个方法来判断整数值是否超出预期范围，如果超出了就要中止网络包的读取和解析，因为会有一些不怀好意的人给我们发送恶意网络包希望我们的程序和内存崩溃掉。网络包的读取和解析的中止必须是自动化的，而且不能使用异常处理，因为异常处理太慢了会拖累我们的程序。</li>
<li>如果独立的读取和写入函数是手动编解码的，那么维护它们真的是一个噩梦。我们希望能够为包一次性的编写好序列化代码并且没有任何运行时的性能消耗（主要是额外的分支、虚化等等）。</li>
</ul>
</li>
<li>我们为了不想自己手动检查各种可能会被攻击的地方， 需要实现检查自动化， 在下一篇文章 <a href="/2017/02/25/serialization_strategies/" title="构建游戏网络协议二之序列化策略">构建游戏网络协议二之序列化策略</a> 里将会说。<br><strong>. . .</strong><a id="more"></a></li>
</ul>
<h1 id="原文"><a href="#原文" class="headerlink" title="原文"></a>原文</h1><p><a href="https://gafferongames.com/post/reading_and_writing_packets/" target="_blank" rel="noopener">原文出处</a></p>
<p>原文标题 : <strong>Reading and Writing Packets</strong> (<em>Best practices for reading and writing packets</em>)</p>
<hr>
<p></p><h2 id="introduction">Introduction</h2><p></p>
<p>Hi, I’m <a href="https://gafferongames.com/about" target="_blank" rel="noopener">Glenn Fiedler</a> and welcome to <strong><a href="https://gafferongames.com/categories/building-a-game-network-protocol/" target="_blank" rel="noopener">Building a Game Network Protocol</a></strong>.</p><br><p>In this article we&rsquo;re going to explore how AAA multiplayer games like first person shooters read and write packets. We&rsquo;ll start with text based formats then move into binary hand-coded binary formats and bitpacking.</p><br><p>At the end of this article and the next, you should understand exactly how to implement your own packet read and write the same way the pros do it.</p><br><h2 id="background">Background</h2><br><p>Consider a web server. It listens for requests, does some work asynchronously and sends responses back to clients. It’s stateless and generally not real-time, although a fast response time is great. Web servers are most often IO bound.</p><br><p>Game server are different. They&rsquo;re a headless version of the game running in the cloud. As such they are stateful and CPU bound. The traffic patterns are different too. Instead of infrequent request/response from tens of thousands of clients, a game server has far fewer clients, but processes a continuous stream of input packets sent from each client 60 times per-second, and broadcasts out the state of the world to clients 10, 20 or even 60 times per-second.</p><br><p>And this state is <strong>huge</strong>. Thousands of objects with hundreds of properties each. Game network programmers spend a lot of their time optimizing exactly how this state is sent over the network with crazy bit-packing tricks, hand-coded binary formats and delta encoding.</p><br><p>What would happen if we just encoded this world state as XML?</p><br><pre>&lt;world_update world_time=”0.0”&gt;<br>  &lt;object id=”1” class=”player”&gt;<br>    &lt;property name=”position” value=”(0,0,0)”&lt;/property&gt;<br>    &lt;property name=”orientation” value=”(1,0,0,0)”&lt;/property&gt;<br>    &lt;property name=”velocity” value=”(10,0,0)”&lt;/property&gt;<br>    &lt;property name=”health” value=”100”&gt;&lt;/property&gt;<br>    &lt;property name=”weapon” value=”110”&gt;&lt;/property&gt;<br>    … 100s more properties per-object …<br> &lt;/object&gt;<br> &lt;object id=”100” class=”grunt”&gt;<br>   &lt;property name=”position” value=”(100,100,0)”&lt;/property&gt;<br>   &lt;property name=”health” value=”10”&lt;/property&gt;<br> &lt;/object&gt;<br> &lt;object id=”110” class=”weapon”&gt;<br>   &lt;property type=”semi-automatic”&gt;&lt;/property&gt;<br>   &lt;property ammo_in_clip=”8”&gt;&lt;/property&gt;<br>   &lt;property round_in_chamber=”true”&gt;&lt;/property&gt;<br> &lt;/object&gt;<br> … 1000s more objects …<br>&lt;/world_update&gt;<br></pre><br><p>Pretty verbose&hellip; it&rsquo;s hard to see how this would be practical for a large world.</p><br><p>JSON is a bit more compact:</p><br><pre>{<br>  “world_time”: 0.0,<br>  “objects”: {<br>    1: {<br>      “class”: “player”,<br>      “position”: “(0,0,0)”,<br>      “orientation”: “(1,0,0,0)”,<br>      “velocity”: “(10,0,0)”,<br>      “health”: 100,<br>      “weapon”: 110<br>    }<br>    100: {<br>      “class”: “grunt”,<br>      “position”: “(100,100,0)”,<br>      “health”: 10<br>    }<br>    110: {<br>      “class”: “weapon”,<br>      “type: “semi-automatic”<br>      “ammo_in_clip”: 8,<br>      “round_in_chamber”: 1<br>    }<br>    // etc…<br>  }<br>}<br></pre><br><p>But it still suffers from the same problem: the description of the data is larger than the data itself. What if instead of fully describing the world state in each packet, we split it up into two parts?</p><br><ol><br><li><p>A schema that describes the set of object classes and properties per-class, <strong>sent only once</strong> when a client connects to the server.</p></li><br><li><p>Data sent rapidly from server to client, <strong>which is encoded relative to the schema</strong>.</p></li><br></ol><br><p>The schema could look something like this:</p><br><pre>{<br>  “classes”: {<br>    0: “player” {<br>      “properties”: {<br>        0: {<br>          “name”: “position”,<br>          “type”: “vec3f”<br>        }<br>        1: {<br>          “name”: “orientation”,<br>          “type”: “quat4f”<br>        }<br>        2: {<br>          “name”: “velocity”,<br>          “type”: “vec3f”<br>        }<br>        3: {<br>          “name”: “health”,<br>          “type”: “float”<br>        }<br>        4: {<br>          “name”: “weapon”,<br>          “type”: “object”,<br>        }<br>      }<br>    }<br>    1: “grunt”: {<br>      “properties”: {<br>        0: {<br>          “name”: “position”,<br>          “type”: “vec3f”<br>        }<br>        1: {<br>          “name”: “health”,<br>          “type”: “float”<br>        }<br>      }<br>    }<br>    2: “weapon”: {<br>      “properties”: {<br>        0: {<br>          “name”: “type”,<br>          “type”: “enum”,<br>          “enum_values”: [ “revolver”, “semi-automatic” ]<br>        }<br>        1: {<br>          “name”: “ammo_in_clip”,<br>          “type”: “integer”,<br>          “range”: “0..9”,<br>        }<br>        2: {<br>          “name”: “round_in_chamber”,<br>          “type”: “integer”,<br>          “range”: “0..1”<br>        }<br>      }<br>    }<br>  }<br>}</pre><br><p>The schema is quite big, but that&rsquo;s beside the point. It&rsquo;s sent only once, and now the client knows the set of classes in the game world and the number, name, type and range of properties per-class.</p><br><p>With this knowledge we can make the rapidly sent portion of the world state much more compact:</p><br><pre>{<br>  “world_time”: 0.0,<br>  “objects”: {<br>    1: [0,”(0,0,0)”,”(1,0,0,0)”,”(10,0,0)”,100,110],<br>    100: [1,”(100,100,0)”,10],<br>    110: [2,1,8,1]<br>  }<br>}<br></pre><br><p>And we can compress it even further by switching to a custom text format:</p><br><pre>0.0<br>1:0,0,0,0,1,0,0,0,10,0,0,100,110<br>100:1,100,100,0,10<br>110:2,1,8,1<br></pre><br><p>As you can see, it’s much more about what you <strong>don’t send</strong> than what you do.</p><br><h2 id="the-inefficiencies-of-text">The Inefficiencies of Text</h2><br><p>We’ve made good progress on our text format so far, moving from a highly attributed stream that fully describes the data (more description than actual data) to an unattributed text format that&rsquo;s an order of magnitude more efficient.</p><br><p>But there are inherent inefficiencies when using text format for packets:</p><br><ul><br><li><p>We are most often sending data in the range <strong>A-Z</strong>, <strong>a-z</strong> and <strong>0-1</strong>, plus a few other symbols. This wastes the remainder of the <strong>0-255</strong> range for each character sent. From an information theory standpoint, this is an inefficient encoding.</p></li><br><li><p>The text representation of integer values are in the general case much less efficient than the binary format. For example, in text format the worst case unsigned 32 bit integer <strong>4294967295</strong> takes 10 bytes, but in binary format it takes just four.</p></li><br><li><p>In text, even the smallest numbers in <strong>0-9</strong> range require at least one byte, but in binary, smaller values like <strong>0, 11, 31, 100</strong> can be sent with fewer than 8 bits if we know their range ahead of time.</p></li><br><li><p>If an integer value is negative, you have to spend a whole byte on <strong>&rsquo;-&rsquo;</strong> to indicate that.</p></li><br><li><p>Floating point numbers waste one byte specifying the decimal point.</p></li><br><li><p>The text representation of numerical values are variable length: <strong>“5”</strong>, <strong>“12345”</strong>, <strong>“3.141593”. </strong>Because of this we need to spend one byte on a separator after each value so we know when it ends.</p></li><br><li><p>Newlines <strong>&lsquo;\n&rsquo;</strong> or some other separator are required to distinguish between the set of variables belonging to one object and the next. When you have thousands of objects, this really adds up.</p></li><br></ul><br><p>In short, if we wish to optimize any further, it&rsquo;s necessary to switch to a binary format.</p><br><h2 id="switching-to-a-binary-format">Switching to a Binary Format</h2><br><p>In the web world there are some really great libraries that read and write binary formats like <a href="http://bjson.org" target="_blank" rel="noopener">BJSON</a>, <a href="https://developers.google.com/protocol-buffers/" target="_blank" rel="noopener">Protocol Buffers</a>, <a href="https://google.github.io/flatbuffers/" target="_blank" rel="noopener">Flatbuffers</a>, <a href="https://thrift.apache.org" target="_blank" rel="noopener">Thrift</a>, <a href="https://capnproto.org" target="_blank" rel="noopener">Cap’n Proto</a> and <a href="http://msgpack.org/index.html" target="_blank" rel="noopener">MsgPack</a>.</p><br><p>In manay cases, these libraries are great fit for building your game network protocol. But in the fast-paced world of first person shooters where efficiency is paramount, a hand-tuned binary protocol is still the gold standard.</p><br><p>There are a few reasons for this. Web binary formats are designed for situations where versioning of data is <em>extremely</em> important. If you upgrade your backend, older clients should be able to keep talking to it with the old format. Data formats are also expected to be language agnostic. A backend written in Golang should be able to talk with a web client written in JavaScript and other server-side components written in Python or Java.</p><br><p>Game servers are completely different beasts. The client and server are almost always written in the same language (C++), and versioning is much simpler. If a client with an incompatible version tries to connect, that connection is simply rejected. There&rsquo;s simply no need for compatibility across different versions.</p><br><p>So if you don’t need versioning and you don’t need cross-language support what are the benefits for these libraries? Convenience. Ease of use. Not needing to worry about creating, testing and debugging your own binary format.</p><br><p>But this convenience is offset by the fact that these libraries are less efficient and less flexible than a binary protocol we can roll ourselves. So while I encourage you to evaluate these libraries and see if they suit your needs, for the rest of this article, we&rsquo;re going to move forward with a custom binary protocol.</p><br><h2 id="getting-started-with-a-binary-format">Getting Started with a Binary Format</h2><br><p>One option for creating a custom binary protocol is to use the in-memory format of your data structures in C/C++ as the over-the-wire format. People often start here, so although I don’t recommend this approach, lets explore it for a while before we poke holes in it.</p><br><p>First define the set of packets, typically as a union of structs:</p><br><pre>struct Packet<br>{<br>    enum PacketTypeEnum { PACKET_A, PACKET_B, PACKET_C };<br><br>    uint8_t packetType;<br><br>    union<br>    {<br>        struct PacketA<br>        {<br>            int x,y,z;<br>        } a;<br><br>        struct PacketB<br>        {<br>            int numElements;<br>            int elements[MaxElements];<br>        } b;<br><br>        struct PacketC<br>        {<br>            bool x;<br>            short y;<br>            int z;<br>        } c;<br>    };<br>};<br></pre><br><p>When writing the packet, set the first byte in the packet to the packet type number (0, 1 or 2). Then depending on the packet type, memcpy the appropriate union struct into the packet. On read do the reverse: read in the first byte, then according to the packet type, copy the packet data to the corresponding struct.</p><br><p>It couldn’t get simpler. So why do most games avoid this approach?</p><br><p>The first reason is that different compilers and platforms provide different packing of structs. If you go this route you’ll spend a lot of time with <strong>#pragma pack</strong> trying to make sure that different compilers and different platforms lay out the structures in memory exactly the same way.</p><br><p>The next one is endianness. Most computers are mostly <a href="https://en.wikipedia.org/wiki/Endianness#Little-endian" target="_blank" rel="noopener">little endian</a> these days but historically some architectures like PowerPC were <a href="https://en.wikipedia.org/wiki/Endianness#Big-endian" target="_blank" rel="noopener">big endian</a>. If you need to support communication between little endian and big endian machines, the memcpy the struct in and out of the packet approach simply won’t work. At minimum you need to write a function to swap bytes between host and network byte order on read and write for each variable in your struct.</p><br><p>There are other issues as well. If a struct contains pointers you can’t just serialize that value over the network and expect a valid pointer on the other side. Also, if you have variable sized structures, such as an array of 32 elements, but most of the time it’s empty or only has a few elements, it&rsquo;s wasteful to always send the array at worst case size. A better approach would support a variable length encoding that only sends the actual number of elements in the array.</p><br><p>But ultimately, what really drives a stake into the heart of this approach is <strong>security</strong>. It’s a <em>massive</em> security risk to take data coming in over the network and trust it, and that&rsquo;s exactly what you do if you just copy a block of memory sent over the network into your struct. Wheee! What if somebody constructs a malicious <strong>PacketB</strong> and sends it to you with <strong>numElements</strong> = 0xFFFFFFFF?</p><br><p>You should, no you <em>must</em>, at minimum do some sort of per-field checking that values are in range vs. blindly accepting what is sent to you. This is why the memcpy struct approach is rarely used in professional games.</p><br><h2 id="read-and-write-functions">Read and Write Functions</h2><br><p>The next level of sophistication is read and write functions per-packet.</p><br><p>Start with the following simple operations:</p><br><pre>void WriteInteger( Buffer &amp; buffer, uint32_t value );<br>void WriteShort( Buffer &amp; buffer, uint16_t value );<br>void WriteChar( Buffer &amp; buffer, uint8_t value );<br><br>uint32_t ReadInteger( Buffer &amp; buffer );<br>uint16_t ReadShort( Buffer &amp; buffer );<br>uint8_t ReadByte( Buffer &amp; buffer );<br></pre><br><p>These operate on a structure which keeps track of the current position:</p><br><pre>struct Buffer<br>{<br>    uint8_t <em> data;     // pointer to buffer data<br>    int size;           // size of buffer data (bytes)<br>    int index;          // index of next byte to be read/written<br>};<br></em></pre><br><p>The write integer function looks something like this:</p><br><pre>void WriteInteger( Buffer &amp; buffer, uint32_t value )<br>{<br>    assert( buffer.index + 4 &lt;= size );<br>#ifdef BIG_ENDIAN
    ((uint32_t<em>)(buffer.data+buffer.index)) = bswap( value );<br>#else // #ifdef BIG_ENDIAN
    </em>((uint32_t<em>)(buffer.data+buffer.index)) = value;<br>#endif // #ifdef BIG_ENDIAN<br>    buffer.index += 4;<br>}<br></em></pre><br><p>And the read integer function looks like this:</p><br><pre>uint32_t ReadInteger( Buffer &amp; buffer )<br>{<br>    assert( buffer.index + 4 &lt;= size );<br>    uint32_t value;<br>#ifdef BIG_ENDIAN<br>    value = bswap( ((uint32_t<em>)(buffer.data+buffer.index)) );<br>#else // #ifdef BIG_ENDIAN<br>    value = </em>((uint32_t<em>)(buffer.data+buffer.index));<br>#endif // #ifdef BIG_ENDIAN<br>    buffer.index += 4;<br>    return value;<br>}<br></em></pre><br><p>Now, instead of copying across packet data in and out of structs, we implement read and write functions for each packet type:</p><br><pre>struct PacketA<br>{<br>    int x,y,z;<br><br>    void Write( Buffer &amp; buffer )<br>    {<br>        WriteInteger( buffer, x );<br>        WriteInteger( buffer, y );<br>        WriteInteger( buffer, z );<br>    }<br><br>    void Read( Buffer &amp; buffer )<br>    {<br>        ReadInteger( buffer, x );<br>        ReadInteger( buffer, y );<br>        ReadInteger( buffer, z );<br>    }<br>};<br><br>struct PacketB<br>{<br>    int numElements;<br>    int elements[MaxElements];<br><br>    void Write( Buffer &amp; buffer )<br>    {<br>        WriteInteger( buffer, numElements );<br>        for ( int i = 0; i &lt; numElements; ++i )<br>            WriteInteger( buffer, elements[i] );<br>    }<br><br>    void Read( Buffer &amp; buffer )<br>    {<br>        ReadInteger( buffer, numElements );<br>        for ( int i = 0; i &lt; numElements; ++i )<br>            ReadInteger( buffer, elements[i] );<br>    }<br>};<br><br>struct PacketC<br>{<br>    bool x;<br>    short y;<br>    int z;<br><br>    void Write( Buffer &amp; buffer )<br>    {<br>        WriteByte( buffer, x );<br>        WriteShort( buffer, y );<br>        WriteInt( buffer, z );<br>    }<br><br>    void Read( Buffer &amp; buffer )<br>    {<br>        ReadByte( buffer, x );<br>        ReadShort( buffer, y );<br>        ReadInt( buffer, z );<br>    }<br>};<br></pre><br><p>When reading and writing packets, start the packet with a byte specifying the packet type via ReadByte/WriteByte, then according to the packet type, call the read/write on the corresponding packet struct in the union.</p><br><p>Now we have a system that allows machines with different endianness to communicate and supports variable length encoding of elements.</p><br><h2 id="bitpacking">Bitpacking</h2><br><p>What if we have a value in the range [0,1000] we really only need 10 bits to represent all possible values. Wouldn&rsquo;t it be nice if we could write just 10 bits, instead of rounding up to 16? What about boolean values? It would be nice to send these as one bit instead of 8!</p><br><p>One way to implement this is to manually organize your C++ structures into packed integers with bitfields and union tricks, such as grouping all bools together into one integer type via bitfield and serializing them as a group. But this is tedious and error prone and there’s no guarantee that different C++ compilers pack bitfields in memory exactly the same way.</p><br><p>A much more flexible way that trades a small amount of CPU on packet read and write for convenience is a <strong>bitpacker</strong>. This is code that reads and writes non-multiples of 8 bits to a buffer.</p><br><h2 id="writing-bits">Writing Bits</h2><br><p>Many people write bitpackers that work at the byte level. This means they flush bytes to memory as they are filled. This is simpler to code, but the ideal is to read and write words at a time, because modern machines are optimized to work this way instead of farting across a buffer at byte level like it’s 1985.</p><br><p>If you want to write 32 bits at a time, you&rsquo;ll need a scratch word twice that size, eg. uint64_t. The reason is that you need the top half for overflow. For example, if you have just written a value 30 bits long into the scratch buffer, then write another value that is 10 bits long you need somewhere to store 30 + 10 = 40 bits.</p><br><pre>uint64_t scratch;<br>int scratch_bits;<br>int word_index;<br>uint32_t  buffer;<br></pre><br><p>When we start writing with the bitpacker, all these variables are cleared to zero except <strong>buffer</strong> which points to the start of the packet we are writing to. Because we&rsquo;re accessing this packet data at a word level, not byte level, make sure packet buffers lengths are a multiple of 4 bytes.</p><br><p>Let’s say we want to write 3 bits followed by 10 bits, then 24. Our goal is to pack this tightly in the scratch buffer and flush that out to memory, 32 bits at a time. Note that 3 + 10 + 24 = 37. We have to handle this case where the total number of bits don’t evenly divide into 32. This is actually the <em>common case</em>.</p><br><p>At the first step, write the 3 bits to <strong>scratch</strong> like this:</p><br><pre>xxx</pre><br><p><strong>scratch_bits</strong> is now 3.</p><br><p>Next, write 10 bits:</p><br><pre>yyyyyyyyyyxxx</pre><br><p><strong>scratch_bits</strong> is now 13 (3+10).</p><br><p>Next write 24 bits:</p><br><pre>zzzzzzzzzzzzzzzzzzzzzzzzyyyyyyyyyyxxx</pre><br><p><strong>scratch_bits</strong> is now 37 (3+10+24). We’re straddling the 32 bit word boundary in our 64 bit <strong>scratch</strong> variable and have 5 bits in the upper 32 bits (overflow). Flush the lower 32 bits of <strong>scratch</strong> to memory, advance <strong>word_index</strong> by one, shift <strong>scratch</strong> right by 32 and subtract 32 from <strong>scratch_bits</strong>.</p><br><p><strong>scratch</strong> now looks like this:</p><br><pre>zzzzz</pre><br><p>We&rsquo;ve finished writing bits but we still have data in scratch that&rsquo;s not flushed to memory. For this data to be included in the packet we need to make sure to flush any remaining bits in <strong>scratch</strong> to memory at the end of writing.</p><br><p>When we flush a word to memory it is converted to little endian byte order. To see why this is important consider what happens if we flush bytes to memory in big endian order:</p><br><pre>DCBA000E</pre><br><p>Since we fill bits in the word from right to left, the last byte in the packet E is actually on the right. If we try to send this buffer in a packet of 5 bytes (the actual amount of data we have to send) the packet catches 0 for the last byte instead of E. Ouch!</p><br><p>But when we write to memory in little endian order, bytes are reversed back out in memory like this:</p><br><pre>ABCDE000</pre><br><p>And we can write 5 bytes to the network and catch E at the end. Et voilà!</p><br><h2 id="reading-bits">Reading Bits</h2><br><p>To read the bitpacked data, start with the buffer sent over the network:</p><br><pre>ABCDE</pre><br><p>The bit reader has the following state:</p><br><pre>uint64_t scratch;<br>int scratch_bits;<br>int total_bits;<br>int num_bits_read;<br>int word_index;<br>uint32_t <em> buffer;<br></em></pre><br><p>To start all variables are cleared to zero except <strong>total_bits</strong> which is set to the size of the packet as bytes  8, and <strong>buffer</strong> which points to the start of the packet.</p><br><p>The user requests a read of 3 bits. Since <strong>scratch_bits</strong> is zero, it’s time to read in the first word. Read in the word to <strong>scratch</strong>, shifted left by <strong>scratch_bits</strong> (0). Add 32 to <strong>scratch_bits</strong>.</p><br><p>The value of <strong>scratch</strong> is now:</p><br><pre>zzzzzzzzzzzzzzzzzzzyyyyyyyyyyxxx</pre><br><p>Read off the low 3 bits, giving the expected value of:</p><br><pre>xxx</pre><br><p>Shift <strong>scratch</strong> to the right 3 bits and subtract 3 from <strong>scratch_bits</strong>:</p><br><pre>zzzzzzzzzzzzzzzzzzzyyyyyyyyyy</pre><br><p>Read off another 10 bits in the same way, giving the expected value of:</p><br><pre>yyyyyyyyyy</pre><br><p>Scratch now looks like:</p><br><pre>zzzzzzzzzzzzzzzzzzz</pre><br><p>The next read asks for 24 bits but <strong>scratch_bits</strong> is only 19 (=32-10-3).</p><br><p>It’s time to read in the next word. Shifting the word in memory left by <strong>scratch_bits</strong> (19) and or it on top of <strong>scratch</strong>.</p><br><p>Now we have all the bits necessary for z in <strong>scratch</strong>:</p><br><pre>zzzzzzzzzzzzzzzzzzzzzzzz</pre><br><p>Read off 24 bits and shift <strong>scratch</strong> right by 24. <strong>scratch</strong> is now all zeros.</p><br><p>We&rsquo;re done!</p><br><h2 id="beyond-bitpacking">Beyond Bitpacking</h2><br><p>Reading and writing integer values into a packet by specifying the number of bits to read/write is not the most user friendly option.</p><br><p>Consider this example:</p><br><pre>const int MaxElements = 32;<br><br>struct PacketB<br>{<br>    int numElements;<br>    int elements[MaxElements];<br><br>    void Write( BitWriter &amp; writer )<br>    {<br>        WriteBits( writer, numElements, 6 );<br>        for ( int i = 0; i &lt; numElements; ++i )<br>            WriteBits( writer, elements[i] );<br>    }<br><br>    void Read( BitReader &amp; reader )<br>    {<br>        ReadBits( reader, numElements, 6 );<br>        for ( int i = 0; i &lt; numElements; ++i )<br>            ReadBits( reader, elements[i] );<br>    }<br>};<br></pre><br><p>This code looks fine at first glance, but let’s assume that some time later you, or somebody else on your team, increases <strong>MaxElements</strong> from 32 to 200 but forget to update the number of bits required to <strong>7</strong>（注意看<code>WriteBits( writer, numElements, 6 )的6， 现在需要7了</code>）. Now the high bit of <strong>numElements</strong> are being silently truncated on send. It&rsquo;s pretty hard to track something like this down after the fact.</p><br><p>The simplest option is to just turn it around and define the maximum number of elements in terms of the number of bits sent:</p><br><pre>const int MaxElementBits = 7;<br>const int MaxElements = ( 1 &lt;&lt; MaxElementBits ) - 1;<br></pre><br><p>Another option is to get fancy and work out the number of bits required at compile time:</p><br><pre>template &lt;uint32_t x&gt; struct PopCount<br>{<br>    enum { a = x - ( ( x &gt;&gt; 1 ) &amp; 0x55555555 ),<br>           b = ( ( ( a &gt;&gt; 2 ) &amp; 0x33333333 ) + ( a &amp; 0x33333333 ) ),<br>           c = ( ( ( b &gt;&gt; 4 ) + b ) &amp; 0x0f0f0f0f ),<br>           d = c + ( c &gt;&gt; 8 ),<br>           e = d + ( d &gt;&gt; 16 ),<br>    result = e &amp; 0x0000003f };<br>};<br><br>template &lt;uint32_t x&gt; struct Log2<br>{<br>    enum { a = x | ( x &gt;&gt; 1 ),<br>           b = a | ( a &gt;&gt; 2 ),<br>           c = b | ( b &gt;&gt; 4 ),<br>           d = c | ( c &gt;&gt; 8 ),<br>           e = d | ( d &gt;&gt; 16 ),<br>           f = e &gt;&gt; 1,<br>    result = PopCount&lt;f&gt;::result };<br>};<br><br>template &lt;int64_t min, int64_t max&gt; struct BitsRequired<br>{<br>    static const uint32_t result =<br>        ( min == max ) ? 0 : ( Log2&lt;uint32_t(max-min)&gt;::result + 1 );<br>};<br><br>#define BITS_REQUIRED( min, max ) BitsRequired&lt;min,max&gt;::result<br></pre><br><p>Now you can’t mess up the number of bits, and you can specify non-power of two maximum values and it everything works out.</p><br><pre>const int MaxElements = 32;<br>const int MaxElementBits = BITS_REQUIRED( 0, MaxElements );<br></pre><br><p>But be careful when array sizes aren&rsquo;t a power of two! In the example above <strong>MaxElements</strong> is 32, so <strong>MaxElementBits</strong> is 6. This seems fine because all values in [0,32] fit in 6 bits. The problem is that there are additional values within 6 bits that are <em>outside</em> our array bounds: [33,63]. An attacker can use this to construct a malicious packet that corrupts memory!</p><br><p>This leads to the <em>inescapable</em> conclusion that it’s not enough to just specify the number of bits required when reading and writing a value, we must also check that it is within the valid range: [min,max]. This way if a value is outside of the expected range we can detect that and abort read.</p><br><p>I used to implement this using C++ exceptions, but when I profiled, I found it to be incredibly slow. In my experience, it’s much faster to take one of two approaches: set a flag on the bit reader that it should abort, or return false from read functions on failure. But now, in order to be completely safe on read you must to check for error on every read operation.</p><br><pre>const int MaxElements = 32;<br>const int MaxElementBits = BITS_REQUIRED( 0, MaxElements );<br><br>struct PacketB<br>{<br>    int numElements;<br>    int elements[MaxElements];<br><br>    void Write( BitWriter &amp; writer )<br>    {<br>        WriteBits( writer, numElements, MaxElementBits );<br>        for ( int i = 0; i &lt; numElements; ++i )<br>        {<br>            WriteBits( writer, elements[i], 32 );<br>        }<br>    }<br><br>    void Read( BitReader &amp; reader )<br>    {<br>        ReadBits( reader, numElements, MaxElementBits );<br><br>        if ( numElements &gt; MaxElements )<br>        {<br>            reader.Abort();<br>            return;<br>        }<br><br>        for ( int i = 0; i &lt; numElements; ++i )<br>        {<br>            if ( reader.IsOverflow() )<br>                break;<br><br>            ReadBits( buffer, elements[i], 32 );<br>        }<br>    }<br>};<br></pre><br><p>If you miss any of these checks, you expose yourself to buffer overflows and infinite loops when reading packets. Clearly you don’t want this to be a manual step when writing a packet read function. <em>You want it to be automatic</em>, just read the NEXT ARTICLE.</p>



<h1 id="译文">译文</h1>


<p><a href="http://gad.qq.com/program/translateview/7165591" target="_blank" rel="noopener">译文出处</a></p>
<div class="WordSection1"><b style="margin: 0cm 0cm 0.0001pt; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial;"><span style="font-size:12.0pt;line-height:240%;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222;font-weight:normal">译者：陈敬凤（<span>nunu</span>）<span>    </span>审校：崔国军（飞扬<span>971</span>）</span> </b><p class="MsoNormal"><span> </span> </p><br><h2 id="导论">导论</h2><br><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">大家好，我是格伦·菲德勒。欢迎大家阅读我新开的这个系列教程：《构建游戏网络协议》。</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">在这个系列文章中，我将完全从头开始为动作游戏（比如说第一人称射击游戏、近身格斗和实时多人在线战斗竞技场游戏都是动作游戏）基于<span>UDP</span>协议构建一个专业级别的游戏网络协议。我所使用的工具只包括我的<span>Macbook Pro</span>、<span> Sublime Text 3</span>（这是一个很好用的编辑器，非常值得一试）、我信赖的<span>C++</span>编译器和一组<span>UDP</span>套接字。</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222"><br></span></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">我写这个系列文章的目的是分享在过去十年里我在这个领域学到的有关游戏网络方面的专业知识，因为似乎没有人写过这些方面的东西。所以其他的网络程序员到底是如何想如何做的，我想通过这个系列文章来进行一定的分享。如果你觉得这篇文章有价值的话，请在<span>patreon</span>上支持我的写作，这样我可以有机会来写更多的文章。如果你对我的工作进行支持和捐赠的话，你还可以访问到这个系列文章的示例源代码<span>(</span>这些源代码都是开源的<span>,</span>所以您可以使用任何你想用的地方甚至是商业内容上！<span>)</span>以及一个密码以便访问这个网站上还没有发表的一些文章。</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">关于我的情况，已经说得足够多了，现在让我们开始这个系列文章把！</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222"><br></span></p><p class="MsoNormal" align="left" style="line-height: 22.5pt;"><br></p><h2 id="对数据包的读取和写入">对数据包的读取和写入</h2><br><p></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">你是否有想过多人在线游戏是如何读取和写入数据包的？</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">如果你有<span>web</span>开发的背景话，你可能会使用<span>XML</span>、<span>JSON</span>或<span>YAML</span>以文本格式来通过网络发送数据。但大多数游戏网络程序员会嘲笑这种对游戏数据进行编码的建议。他们可能会说：<span>”</span>哈哈哈，这真的很有趣。你不是认真的对吧？<span>“</span>哦。你<span>…</span>是认真的。你被解雇了。你可以收拾东西回家了。</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">我只是开了一个玩笑，但是玩笑归玩笑，为什么这种方法不好？</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">一个网页服务器位于网络上的某个位置，监听请求并发送响应。这些请求和响应都是无状态的并且对实时性要求非常非常低（当然有个快速的响应是非常重要的，但是如果不是这种情况也没什么关系）。因为无状态和请求<span>/</span>响应的频率非常低，所以具有非常良好的扩展性。但是多人在线游戏的服务器与这种网页服务器完全是不同的。它是以每秒<span>60</span>次的速度来对游戏世界的状态进行模拟。它是实时的并且有状态的，并且需要把所有的状态以每秒<span>20</span>次或者<span>30</span>次的频率下发给客户端。因为整个游戏世界有几千个物体，每个物体可能会有几百个状态，所以下发给客户端的状态可能是海量的。</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">如果你使用文本格式<span>(</span>如<span>XML</span>或<span>JSON)</span>对这个游戏状态进行编码的话，有可能这种方法是非常低效的。</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">让我们举个简单的例子，看下下面这个<span>XML</span>文档：</span> </p><div><div id="highlighter_836053" class="syntaxhighlighter  xml"><div><div id="highlighter_745852" class="syntaxhighlighter  xml"><div class="toolbar"><a class="toolbar_item command_help help">?</a></div><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="xml plain">&lt;</code><code class="xml keyword">world_update</code> <code class="xml color1">world_time</code><code class="xml plain">=</code><code class="xml string">“0.0”</code><code class="xml plain">&gt;</code></div><div class="line number2 index1 alt1"><code class="xml spaces">  </code><code class="xml plain">&lt;</code><code class="xml keyword">object</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">“1”</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">“player”</code><code class="xml plain">&gt;</code></div><div class="line number3 index2 alt2"><code class="xml spaces">    </code><code class="xml plain">&lt;</code><code class="xml keyword">property</code> <code class="xml color1">name</code><code class="xml plain">=</code><code class="xml string">“position”</code> <code class="xml color1">value</code><code class="xml plain">=</code><code class="xml string">“(0,0,0)”</code> <code class="xml plain">&lt;=”” </code><code class="xml color1">property</code><code class="xml plain">=</code><code class="xml string">“”</code><code class="xml plain">&gt;</code></div><div class="line number4 index3 alt1"><code class="xml spaces">    </code><code class="xml plain">&lt;</code><code class="xml keyword">property</code> <code class="xml color1">name</code><code class="xml plain">=</code><code class="xml string">“orientation”</code> <code class="xml color1">value</code><code class="xml plain">=</code><code class="xml string">“(1,0,0,0)”</code> <code class="xml plain">&lt;=”” </code><code class="xml color1">property</code><code class="xml plain">=</code><code class="xml string">“”</code><code class="xml plain">&gt;</code></div><div class="line number5 index4 alt2"><code class="xml spaces">    </code><code class="xml plain">&lt;</code><code class="xml keyword">property</code> <code class="xml color1">name</code><code class="xml plain">=</code><code class="xml string">“velocity”</code> <code class="xml color1">value</code><code class="xml plain">=</code><code class="xml string">“(10,0,0)”</code> <code class="xml plain">&lt;=”” </code><code class="xml color1">property</code><code class="xml plain">=</code><code class="xml string">“”</code><code class="xml plain">&gt;</code></div><div class="line number6 index5 alt1"><code class="xml spaces">    </code><code class="xml plain">&lt;</code><code class="xml keyword">property</code> <code class="xml color1">name</code><code class="xml plain">=</code><code class="xml string">“health”</code> <code class="xml color1">value</code><code class="xml plain">=</code><code class="xml string">“100”</code><code class="xml plain">&gt;&lt;/</code><code class="xml keyword">property</code><code class="xml plain">&gt;</code></div><div class="line number7 index6 alt2"><code class="xml spaces">    </code><code class="xml plain">&lt;</code><code class="xml keyword">property</code> <code class="xml color1">name</code><code class="xml plain">=</code><code class="xml string">“weapon”</code> <code class="xml color1">value</code><code class="xml plain">=</code><code class="xml string">“110”</code><code class="xml plain">&gt;&lt;/</code><code class="xml keyword">property</code><code class="xml plain">&gt;</code></div><div class="line number8 index7 alt1"><code class="xml spaces">    </code><code class="xml plain">… 100s more properties per-object …</code></div><div class="line number9 index8 alt2"><code class="xml spaces">   </code><code class="xml plain">&lt;/</code><code class="xml keyword">property</code><code class="xml plain">&gt;&lt;/</code><code class="xml keyword">property</code><code class="xml plain">&gt;&lt;/</code><code class="xml keyword">property</code><code class="xml plain">&gt;&lt;/</code><code class="xml keyword">object</code><code class="xml plain">&gt;</code></div><div class="line number10 index9 alt1"><code class="xml spaces"> </code><code class="xml plain">&lt;</code><code class="xml keyword">object</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">“100”</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">“grunt”</code><code class="xml plain">&gt;</code></div><div class="line number11 index10 alt2"><code class="xml spaces">   </code><code class="xml plain">&lt;</code><code class="xml keyword">property</code> <code class="xml color1">name</code><code class="xml plain">=</code><code class="xml string">“position”</code> <code class="xml color1">value</code><code class="xml plain">=</code><code class="xml string">“(100,100,0)”</code> <code class="xml plain">&lt;=”” </code><code class="xml color1">property</code><code class="xml plain">=</code><code class="xml string">“”</code><code class="xml plain">&gt;</code></div><div class="line number12 index11 alt1"><code class="xml spaces">   </code><code class="xml plain">&lt;</code><code class="xml keyword">property</code> <code class="xml color1">name</code><code class="xml plain">=</code><code class="xml string">“health”</code> <code class="xml color1">value</code><code class="xml plain">=</code><code class="xml string">“10”</code> <code class="xml plain">&lt;=”” </code><code class="xml color1">property</code><code class="xml plain">=</code><code class="xml string">“”</code><code class="xml plain">&gt;</code></div><div class="line number13 index12 alt2"><code class="xml spaces"> </code><code class="xml plain">&lt;/</code><code class="xml keyword">property</code><code class="xml plain">&gt;&lt;/</code><code class="xml keyword">property</code><code class="xml plain">&gt;&lt;/</code><code class="xml keyword">object</code><code class="xml plain">&gt;</code></div><div class="line number14 index13 alt1"><code class="xml spaces"> </code><code class="xml plain">&lt;</code><code class="xml keyword">object</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">“110”</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">“weapon”</code><code class="xml plain">&gt;</code></div><div class="line number15 index14 alt2"><code class="xml spaces">   </code><code class="xml plain">&lt;</code><code class="xml keyword">property</code> <code class="xml color1">type</code><code class="xml plain">=</code><code class="xml string">“semi-automatic”</code><code class="xml plain">&gt;&lt;/</code><code class="xml keyword">property</code><code class="xml plain">&gt;</code></div><div class="line number16 index15 alt1"><code class="xml spaces">   </code><code class="xml plain">&lt;</code><code class="xml keyword">property</code> <code class="xml color1">ammo_in_clip</code><code class="xml plain">=</code><code class="xml string">“8”</code><code class="xml plain">&gt;&lt;/</code><code class="xml keyword">property</code><code class="xml plain">&gt;</code></div><div class="line number17 index16 alt2"><code class="xml spaces">   </code><code class="xml plain">&lt;</code><code class="xml keyword">property</code> <code class="xml color1">round_in_chamber</code><code class="xml plain">=</code><code class="xml string">“true”</code><code class="xml plain">&gt;&lt;/</code><code class="xml keyword">property</code><code class="xml plain">&gt;</code></div><div class="line number18 index17 alt1"><code class="xml spaces"> </code><code class="xml plain">&lt;/</code><code class="xml keyword">object</code><code class="xml plain">&gt;</code></div><div class="line number19 index18 alt2"><code class="xml spaces"> </code><code class="xml plain">… 1000s more objects …</code></div><div class="line number20 index19 alt1"><code class="xml plain">&lt;/</code><code class="xml keyword">world_update</code><code class="xml plain">&gt;</code></div></div></td></tr></table></div></div></div></div><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222"> </span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">这看上去真的很让人讨厌。我们可以做得更好吗<span>?</span>当然。。。使用<span>JSON</span>来编码的话文本量可以少一些：</span> </p><div><div id="highlighter_819404" class="syntaxhighlighter  json"><div class="toolbar"><a class="toolbar_item command_help help">?</a></div><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="json plain">{</code></div><div class="line number2 index1 alt1"><code class="json spaces">  </code><code class="json string">“world_time”</code><code class="json plain">: 0.0,</code></div><div class="line number3 index2 alt2"><code class="json spaces">  </code><code class="json string">“objects”</code><code class="json plain">: {</code></div><div class="line number4 index3 alt1"><code class="json spaces">    </code><code class="json plain">1: {</code></div><div class="line number5 index4 alt2"><code class="json spaces">      </code><code class="json string">“class”</code><code class="json plain">: </code><code class="json string">“player”</code><code class="json plain">,</code></div><div class="line number6 index5 alt1"><code class="json spaces">      </code><code class="json string">“position”</code><code class="json plain">: </code><code class="json string">“(0,0,0)”</code><code class="json plain">,</code></div><div class="line number7 index6 alt2"><code class="json spaces">      </code><code class="json string">“orientation”</code><code class="json plain">: </code><code class="json string">“(1,0,0,0)”</code><code class="json plain">,</code></div><div class="line number8 index7 alt1"><code class="json spaces">      </code><code class="json string">“velocity”</code><code class="json plain">: </code><code class="json string">“(10,0,0)”</code><code class="json plain">,</code></div><div class="line number9 index8 alt2"><code class="json spaces">      </code><code class="json string">“health”</code><code class="json plain">: 100,</code></div><div class="line number10 index9 alt1"><code class="json spaces">      </code><code class="json string">“weapon”</code><code class="json plain">: 110</code></div><div class="line number11 index10 alt2"><code class="json spaces">    </code><code class="json plain">}</code></div><div class="line number12 index11 alt1"><code class="json spaces">    </code><code class="json plain">100: {</code></div><div class="line number13 index12 alt2"><code class="json spaces">      </code><code class="json string">“class”</code><code class="json plain">: </code><code class="json string">“grunt”</code><code class="json plain">,</code></div><div class="line number14 index13 alt1"><code class="json spaces">      </code><code class="json string">“position”</code><code class="json plain">: </code><code class="json string">“(100,100,0)”</code><code class="json plain">,</code></div><div class="line number15 index14 alt2"><code class="json spaces">      </code><code class="json string">“health”</code><code class="json plain">: 10</code></div><div class="line number16 index15 alt1"><code class="json spaces">    </code><code class="json plain">}</code></div><div class="line number17 index16 alt2"><code class="json spaces">    </code><code class="json plain">110: {</code></div><div class="line number18 index17 alt1"><code class="json spaces">      </code><code class="json string">“class”</code><code class="json plain">: </code><code class="json string">“weapon”</code><code class="json plain">,</code></div><div class="line number19 index18 alt2"><code class="json spaces">      </code><code class="json string">“type: “</code><code class="json plain">semi-automatic</code><code class="json string">“</code></div><div class="line number20 index19 alt1"><code class="json spaces">      </code><code class="json string">“</code><code class="json plain">ammo_in_clip</code><code class="json string">“: 8,</code></div><div class="line number21 index20 alt2"><code class="json spaces">      </code><code class="json string">“</code><code class="json plain">round_in_chamber”: 1 </code></div><div class="line number22 index21 alt1"><code class="json spaces">    </code><code class="json plain">}</code></div><div class="line number23 index22 alt2"><code class="json spaces">  </code><code class="json plain">}</code></div><div class="line number24 index23 alt1"><code class="json plain">}</code></div></div></td></tr></table></div></div><p class="MsoNormal" align="left"><br></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">但要注意的是描述数据的属性比实际要发送的数据还大。这糟透了。</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">但是如果我们把数据分成两个部分呢<span>?</span></span> </p><p class="MsoNormal" align="left" style="margin-left: 36.05pt; text-indent: -18pt;"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">1.<span style="font-variant-numeric: normal; font-stretch: normal; font-size: 7pt; line-height: normal; font-family: &quot;Times New Roman&quot;;">    </span></span><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">一个模式来描述物体类的几何以及每个类的属性。</span> </p><p class="MsoNormal" align="left" style="margin-left: 36.05pt; text-indent: -18pt;"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">2.<span style="font-variant-numeric: normal; font-stretch: normal; font-size: 7pt; line-height: normal; font-family: &quot;Times New Roman&quot;;">    </span></span><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">数据相对于该模式进行编码来快速下发给各个客户端。</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">下面是<span>JSON</span>的一个模式。它只会被下发一次：</span><span style="color: rgb(34, 34, 34); font-family: 微软雅黑, sans-serif; font-size: 12pt;"> </span></p><div><div id="highlighter_69521" class="syntaxhighlighter  json"><div class="toolbar"><a class="toolbar_item command_help help">?</a></div><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div><div class="line number40 index39 alt1">40</div><div class="line number41 index40 alt2">41</div><div class="line number42 index41 alt1">42</div><div class="line number43 index42 alt2">43</div><div class="line number44 index43 alt1">44</div><div class="line number45 index44 alt2">45</div><div class="line number46 index45 alt1">46</div><div class="line number47 index46 alt2">47</div><div class="line number48 index47 alt1">48</div><div class="line number49 index48 alt2">49</div><div class="line number50 index49 alt1">50</div><div class="line number51 index50 alt2">51</div><div class="line number52 index51 alt1">52</div><div class="line number53 index52 alt2">53</div><div class="line number54 index53 alt1">54</div><div class="line number55 index54 alt2">55</div><div class="line number56 index55 alt1">56</div><div class="line number57 index56 alt2">57</div><div class="line number58 index57 alt1">58</div><div class="line number59 index58 alt2">59</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="json plain">{</code></div><div class="line number2 index1 alt1"><code class="json spaces">  </code><code class="json string">“classes”</code><code class="json plain">: {</code></div><div class="line number3 index2 alt2"><code class="json spaces">    </code><code class="json plain">0: </code><code class="json string">“player”</code> <code class="json plain">{</code></div><div class="line number4 index3 alt1"><code class="json spaces">      </code><code class="json string">“properties”</code><code class="json plain">: {</code></div><div class="line number5 index4 alt2"><code class="json spaces">        </code><code class="json plain">0: {</code></div><div class="line number6 index5 alt1"><code class="json spaces">          </code><code class="json string">“name”</code><code class="json plain">: </code><code class="json string">“position”</code><code class="json plain">,</code></div><div class="line number7 index6 alt2"><code class="json spaces">          </code><code class="json string">“type”</code><code class="json plain">: </code><code class="json string">“vec3f”</code></div><div class="line number8 index7 alt1"><code class="json spaces">        </code><code class="json plain">}</code></div><div class="line number9 index8 alt2"><code class="json spaces">        </code><code class="json plain">1: {</code></div><div class="line number10 index9 alt1"><code class="json spaces">          </code><code class="json string">“name”</code><code class="json plain">: </code><code class="json string">“orientation”</code><code class="json plain">,</code></div><div class="line number11 index10 alt2"><code class="json spaces">          </code><code class="json string">“type”</code><code class="json plain">: </code><code class="json string">“quat4f”</code></div><div class="line number12 index11 alt1"><code class="json spaces">        </code><code class="json plain">}</code></div><div class="line number13 index12 alt2"><code class="json spaces">        </code><code class="json plain">2: {</code></div><div class="line number14 index13 alt1"><code class="json spaces">          </code><code class="json string">“name”</code><code class="json plain">: </code><code class="json string">“velocity”</code><code class="json plain">,</code></div><div class="line number15 index14 alt2"><code class="json spaces">          </code><code class="json string">“type”</code><code class="json plain">: </code><code class="json string">“vec3f”</code></div><div class="line number16 index15 alt1"><code class="json spaces">        </code><code class="json plain">}</code></div><div class="line number17 index16 alt2"><code class="json spaces">        </code><code class="json plain">3: {</code></div><div class="line number18 index17 alt1"><code class="json spaces">          </code><code class="json string">“name”</code><code class="json plain">: </code><code class="json string">“health”</code><code class="json plain">,</code></div><div class="line number19 index18 alt2"><code class="json spaces">          </code><code class="json string">“type”</code><code class="json plain">: </code><code class="json string">“float”</code></div><div class="line number20 index19 alt1"><code class="json spaces">        </code><code class="json plain">}</code></div><div class="line number21 index20 alt2"><code class="json spaces">        </code><code class="json plain">4: {</code></div><div class="line number22 index21 alt1"><code class="json spaces">          </code><code class="json string">“name”</code><code class="json plain">: </code><code class="json string">“weapon”</code><code class="json plain">,</code></div><div class="line number23 index22 alt2"><code class="json spaces">          </code><code class="json string">“type”</code><code class="json plain">: </code><code class="json string">“object”</code><code class="json plain">, </code></div><div class="line number24 index23 alt1"><code class="json spaces">        </code><code class="json plain">}</code></div><div class="line number25 index24 alt2"><code class="json spaces">      </code><code class="json plain">}</code></div><div class="line number26 index25 alt1"><code class="json spaces">    </code><code class="json plain">}</code></div><div class="line number27 index26 alt2"><code class="json spaces">    </code><code class="json plain">1: </code><code class="json string">“grunt”</code><code class="json plain">: {</code></div><div class="line number28 index27 alt1"><code class="json spaces">      </code><code class="json string">“properties”</code><code class="json plain">: {</code></div><div class="line number29 index28 alt2"><code class="json spaces">        </code><code class="json plain">0: {</code></div><div class="line number30 index29 alt1"><code class="json spaces">          </code><code class="json string">“name”</code><code class="json plain">: </code><code class="json string">“position”</code><code class="json plain">,</code></div><div class="line number31 index30 alt2"><code class="json spaces">          </code><code class="json string">“type”</code><code class="json plain">: </code><code class="json string">“vec3f”</code></div><div class="line number32 index31 alt1"><code class="json spaces">        </code><code class="json plain">}</code></div><div class="line number33 index32 alt2"><code class="json spaces">        </code><code class="json plain">1: {</code></div><div class="line number34 index33 alt1"><code class="json spaces">          </code><code class="json string">“name”</code><code class="json plain">: </code><code class="json string">“health”</code><code class="json plain">,</code></div><div class="line number35 index34 alt2"><code class="json spaces">          </code><code class="json string">“type”</code><code class="json plain">: </code><code class="json string">“float”</code></div><div class="line number36 index35 alt1"><code class="json spaces">        </code><code class="json plain">}</code></div><div class="line number37 index36 alt2"><code class="json spaces">      </code><code class="json plain">}</code></div><div class="line number38 index37 alt1"><code class="json spaces">    </code><code class="json plain">}</code></div><div class="line number39 index38 alt2"><code class="json spaces">    </code><code class="json plain">2: </code><code class="json string">“weapon”</code><code class="json plain">: {</code></div><div class="line number40 index39 alt1"><code class="json spaces">      </code><code class="json string">“properties”</code><code class="json plain">: {</code></div><div class="line number41 index40 alt2"><code class="json spaces">        </code><code class="json plain">0: {</code></div><div class="line number42 index41 alt1"><code class="json spaces">          </code><code class="json string">“name”</code><code class="json plain">: </code><code class="json string">“type”</code><code class="json plain">,</code></div><div class="line number43 index42 alt2"><code class="json spaces">          </code><code class="json string">“type”</code><code class="json plain">: </code><code class="json string">“enum”</code><code class="json plain">,</code></div><div class="line number44 index43 alt1"><code class="json spaces">          </code><code class="json string">“enum_values”</code><code class="json plain">: [ </code><code class="json string">“revolver”</code><code class="json plain">, </code><code class="json string">“semi-automatic”</code> <code class="json plain">]</code></div><div class="line number45 index44 alt2"><code class="json spaces">        </code><code class="json plain">}</code></div><div class="line number46 index45 alt1"><code class="json spaces">        </code><code class="json plain">1: {</code></div><div class="line number47 index46 alt2"><code class="json spaces">          </code><code class="json string">“name”</code><code class="json plain">: </code><code class="json string">“ammo_in_clip”</code><code class="json plain">,</code></div><div class="line number48 index47 alt1"><code class="json spaces">          </code><code class="json string">“type”</code><code class="json plain">: </code><code class="json string">“integer”</code><code class="json plain">,</code></div><div class="line number49 index48 alt2"><code class="json spaces">          </code><code class="json string">“range”</code><code class="json plain">: </code><code class="json string">“0..9”</code><code class="json plain">,</code></div><div class="line number50 index49 alt1"><code class="json spaces">        </code><code class="json plain">}</code></div><div class="line number51 index50 alt2"><code class="json spaces">        </code><code class="json plain">2: {</code></div><div class="line number52 index51 alt1"><code class="json spaces">          </code><code class="json string">“name”</code><code class="json plain">: </code><code class="json string">“round_in_chamber”</code><code class="json plain">,</code></div><div class="line number53 index52 alt2"><code class="json spaces">          </code><code class="json string">“type”</code><code class="json plain">: </code><code class="json string">“integer”</code><code class="json plain">,</code></div><div class="line number54 index53 alt1"><code class="json spaces">          </code><code class="json string">“range”</code><code class="json plain">: </code><code class="json string">“0..1”</code></div><div class="line number55 index54 alt2"><code class="json spaces">        </code><code class="json plain">}</code></div><div class="line number56 index55 alt1"><code class="json spaces">      </code><code class="json plain">}</code></div><div class="line number57 index56 alt2"><code class="json spaces">    </code><code class="json plain">}  </code></div><div class="line number58 index57 alt1"><code class="json spaces">  </code><code class="json plain">}</code></div><div class="line number59 index58 alt2"><code class="json plain">}</code></div></div></td></tr></table></div></div><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222"> </span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">现在我们可以更加紧凑的进行状态更新<span>(</span>每秒进行<span>20</span>次或<span>30</span>次状态更新<span>…)</span>：</span> </p><div><div id="highlighter_532621" class="syntaxhighlighter  json"><div class="toolbar"><a class="toolbar_item command_help help">?</a></div><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="json plain">{</code></div><div class="line number2 index1 alt1"><code class="json spaces">  </code><code class="json string">“world_time”</code><code class="json plain">: 0.0,</code></div><div class="line number3 index2 alt2"><code class="json spaces">  </code><code class="json string">“objects”</code><code class="json plain">: {</code></div><div class="line number4 index3 alt1"><code class="json spaces">    </code><code class="json plain">1: [0,</code><code class="json string">“(0,0,0)”</code><code class="json plain">,</code><code class="json string">“(1,0,0,0)”</code><code class="json plain">,</code><code class="json string">“(10,0,0)”</code><code class="json plain">,100,110],</code></div><div class="line number5 index4 alt2"><code class="json spaces">    </code><code class="json plain">100: [1,</code><code class="json string">“(100,100,0)”</code><code class="json plain">,10],</code></div><div class="line number6 index5 alt1"><code class="json spaces">    </code><code class="json plain">110: [2,1,8,1]</code></div><div class="line number7 index6 alt2"><code class="json spaces">  </code><code class="json plain">}</code></div><div class="line number8 index7 alt1"><code class="json plain">}</code></div></div></td></tr></table></div></div><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222"> </span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">这确实更好一点了。但是我们为什么不能直接下发一个简单的文本格式而没有任何废话吗<span>?</span></span> </p><div><div id="highlighter_467241" class="syntaxhighlighter  csharp"><div class="toolbar"><a class="toolbar_item command_help help">?</a></div><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="csharp plain">0.0</code></div><div class="line number2 index1 alt1"><code class="csharp plain">1:0,0,0,0,1,0,0,0,10,0,0,100,110</code></div><div class="line number3 index2 alt2"><code class="csharp plain">100:1,100,100,0,10</code></div><div class="line number4 index3 alt1"><code class="csharp plain">110:2,1,8,1</code></div></div></td></tr></table></div></div><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222"> </span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">这比原来紧凑多了。当然它在没有模式的情况下是完全不可读的，但是这也是整个问题的所在。</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222"><br></span></p><br><h2 id="文本格式存在的问题">文本格式存在的问题</h2><br><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">我们确实取得了一些进展，但是我们仍然在使用文本格式，所以就继承了文本格式固有的低效。</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">为什么？</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">让我们以一个浮点数为例来分析这个问题。在二进制格式中一个浮点数需要占据<span>4</span>个字节，但是在文本格式下一个浮点数需要多的多的空间。让我们举个简单的例子：“<span>3.141592653589793”</span>一共用了<span>17</span>个字节（并没有包括终止符‘<span>\0</span>’）。当然你可以说让我们把这个浮点数缩短到<span>6</span>位有效数字的情况。但是就算我们这样处理了，所得到的“<span>3.141593</span>”所占据的空间仍然是二进制表示法的<span>2</span>倍大小。<span><br></span>更糟糕的是如果你有一个很大的表示位置的数值，比如<span>”12134.534112”</span>。 你仍然需要<span>6</span>位精度的准确性所以现在你需要使用<span>12</span>个字节来表示这个浮点数。而这样所占据的空间是二进制表示法的<span>3</span>倍大小。你还会为每一个<span>‘,’</span>分隔符浪费一个字节。</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">我希望你能看到，在多人在线游戏中使用文本格式进行通信是完全不可行的。“但是格伦，整个互联网都是构建于文本格式之上的，为什么在多人在线游戏中使用文本格式进行通信完全不可行？”。恩，我认为这是那些创造互联网的人在这个过程中犯下的一些错误。<span>(</span>译注：原作者的这个结论下的太武断了，我觉得主要是因为互联网和游戏通信协议的面向对象不同，游戏通信协议面向的目标是非常特定而且固定的，这使得他们可以提前沟通到底以什么格式来传输协议，或者说不需要传输任何解读的标签就能够互相理解，而这种互相理解的基础是通过其他方式已经进行了沟通，但是互联网的通信则是完全不同的，它要非常的通用，兼顾更多的需求，而且根本就不知道是谁来解读这些信息，所以信息的可读性就非常非常的重要，因为我们没有其他的管道进行通信，只能凭借传输过去的信息本身来解读，所以互联网的协议才是设计成这样。<span>)</span>。可读性可能在这些早期协议很重要，但我可以向你保证，让人们很容易来阅读这些协议和修改你的游戏的网络协议正好是硬币的两面，根本没有办法兼得。</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">而且因为带宽是非常关键的要素，并且你希望在每秒用尽可能少的比特数来传递尽可能多的游戏内容，所以你完全没有办法使用文本格式，必须切换成二进制格式。</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222"><br></span></p><br><h2 id="切换成二进制格式">切换成二进制格式</h2><br><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">在网络世界中存在一些用来读取和写入二进制格式的库，比如</span><span><a rel="noopener" href="http://bjson.org/" target="_blank"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;">BJSON</span></a></span><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">,</span><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">、</span><span><a rel="noopener" href="https://developers.google.com/protocol-buffers/" target="_blank"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;">Protocol Buffers</span></a></span><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">、 </span><span><a rel="noopener" href="https://google.github.io/flatbuffers/" target="_blank"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;">Flatbuffers</span></a></span><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">、 </span><span><a rel="noopener" href="https://thrift.apache.org/" target="_blank"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;">Thrift</span></a></span><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">、 </span><span><a rel="noopener" href="https://capnproto.org/" target="_blank"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;">Cap’n Proto</span></a></span><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222"> </span><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">和 </span><span><a rel="noopener" href="http://msgpack.org/index.html" target="_blank"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;">MsgPack</span></a></span><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">。这几乎都是常识了。</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">这些库其实都还不错。借助接口描述语言和一些代码生成工具的帮助能够读取和写入（这通常被称为序列化）你的游戏数据结构成为二进制格式，而这些二进制数据会在网络上进行传递。在网络的另外一侧，这些数据会被反序列化并且转换回原始的数据结构。</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">使用二进制格式进行传说网络数据的优点有：<span>1)</span></span><span> </span><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">你不必自己动手写一个序列化层。<span>2</span>）这些库往往是语言无关的，所以你可以在程序的前端（也就是客户端）使用一种语言而在程序的后端（也就是服务端）使用另外一种语言，而在这种情况下手，程序的前端和程序的后端仍然是可以进行通信的。<span>3)</span>提供了版本信息，这样的话，如果你的客户端使用的是一个比较旧版本的协议，而服务器使用的是一个比较新版本的协议的话，它们仍然是可以进行通信的。反过来也是一样。</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">这些库看上去很棒，但是它们是实现你的游戏的网络协议的一种很棒的方法么？</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">其实情况并不总是如此。如果你有一个协议，这个协议是负责向网页服务器进行请求和接受响应，但是需要支持多种语言并且版本信息对你来说非常的重要，那么在这种情况下，因为有了可以支持这些功能的库的存在，你再自己去实现自己的带版本信息的序列化层和多语言支持就是一件特别傻的事情。如果你的游戏需要从一台机器上远程调用另外一台机器的函数。那么可能只用这些已有的库就是完全没问题的。。。</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">但是在性能至关重要的网络通信的情况下，比如我们在这篇文章中讨论的这种情况（对于第一人称射击游戏游戏、动作游戏等等），游戏网络的基本单位是状态而不是远程函数调用。同时<span>,</span>跨语言支持二进制格式所能提供的好处很小，这是因为客户端和服务器通常情况下都是使用一种语言进行开发的（比如<span>C++</span>）。这些游戏也不需要复杂的版本信息和版本验证机制，因为如何客户端试图以一个不同的协议版本与服务器进行连接的话，那么服务器可以直接拒绝这个连接就好。有一种特别简单但是有效的办法可以解决版本的问题，就是绕过客户端永远用和服务器相同的协议版本进行连接。</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">所以如果你的协议不是大部分使用远程函数调用的话，你其实根本就不需要版本信息，也不需要什么跨语言的支持，到底这么做有什么好处？从我的观点来看好处其实并不多。所以让我们直接忽略掉这些功能并用我们自己的不带属性的二进制流进行代替，在这个过程中我们可以获得更多的控制性和灵活性。</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222"><br></span></p><p class="MsoNormal" align="left" style="line-height: 22.5pt;"><br></p><h2 id="如何开始使用二进制格式">如何开始使用二进制格式</h2><br><p></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">如果你在用<span>C</span>或<span>C++</span>对你的游戏进行编码，你可能想知道为什么不能直接使用<span>memcpy</span>（这是一个函数，可以直接进行内存拷贝<span>, </span>将<span>n</span>字节长的内容从一个内存地址复制到另一个地址）把我的结构拷贝到数据包里面？很多人会经常从这里开始，因此尽管我不推荐这种方法，还是让我们看下这个方法，看看如果用这个方法来进行网络包传递的话会有哪些问题。</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">首先要定义你的数据包的集合，通常情况下这是结构的<span>”</span>联合<span>“</span>（<span>C</span>语言的一种语法名字）：</span> </p><div><div id="highlighter_21108" class="syntaxhighlighter  cpp"><div class="toolbar"><a class="toolbar_item command_help help">?</a></div><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp keyword bold">struct</code> <code class="cpp plain">Packet</code></div><div class="line number2 index1 alt1"><code class="cpp plain">{</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">    </code><code class="cpp keyword bold">enum</code> <code class="cpp plain">PacketTypeEnum { PACKET_A, PACKET_B, PACKET_C };</code></div><div class="line number4 index3 alt1"> </div><div class="line number5 index4 alt2"><code class="cpp spaces">    </code><code class="cpp plain">uint8_t packetType;</code></div><div class="line number6 index5 alt1"><code class="cpp spaces"> </code> </div><div class="line number7 index6 alt2"><code class="cpp spaces">    </code><code class="cpp keyword bold">union</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">    </code><code class="cpp plain">{</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">        </code><code class="cpp keyword bold">struct</code> <code class="cpp plain">PacketA</code></div><div class="line number10 index9 alt1"><code class="cpp spaces">        </code><code class="cpp plain">{</code></div><div class="line number11 index10 alt2"><code class="cpp spaces">            </code><code class="cpp color1 bold">int</code> <code class="cpp plain">x,y,z;</code></div><div class="line number12 index11 alt1"><code class="cpp spaces">        </code><code class="cpp plain">} a;</code></div><div class="line number13 index12 alt2"> </div><div class="line number14 index13 alt1"><code class="cpp spaces">        </code><code class="cpp keyword bold">struct</code> <code class="cpp plain">PacketB</code></div><div class="line number15 index14 alt2"><code class="cpp spaces">        </code><code class="cpp plain">{</code></div><div class="line number16 index15 alt1"><code class="cpp spaces">            </code><code class="cpp color1 bold">int</code> <code class="cpp plain">numElements;</code></div><div class="line number17 index16 alt2"><code class="cpp spaces">            </code><code class="cpp color1 bold">int</code> <code class="cpp plain">elements[MaxElements];</code></div><div class="line number18 index17 alt1"><code class="cpp spaces">        </code><code class="cpp plain">} b;</code></div><div class="line number19 index18 alt2"> </div><div class="line number20 index19 alt1"><code class="cpp spaces">        </code><code class="cpp keyword bold">struct</code> <code class="cpp plain">PacketC</code></div><div class="line number21 index20 alt2"><code class="cpp spaces">        </code><code class="cpp plain">{</code></div><div class="line number22 index21 alt1"><code class="cpp spaces">            </code><code class="cpp color1 bold">bool</code> <code class="cpp plain">x;</code></div><div class="line number23 index22 alt2"><code class="cpp spaces">            </code><code class="cpp color1 bold">short</code> <code class="cpp plain">y;</code></div><div class="line number24 index23 alt1"><code class="cpp spaces">            </code><code class="cpp color1 bold">int</code> <code class="cpp plain">z;</code></div><div class="line number25 index24 alt2"><code class="cpp spaces">        </code><code class="cpp plain">} c;</code></div><div class="line number26 index25 alt1"><code class="cpp spaces">    </code><code class="cpp plain">}; </code></div><div class="line number27 index26 alt2"><code class="cpp plain">};</code></div></div></td></tr></table></div></div><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222"> </span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">当对数据包进行写入的时候，设置数据包的第一个字节为数据包的类型（<span>0</span>或者<span>1</span>或者<span>2</span>）。然后依据数据包的类型，使用<span>memcpy</span>函数将合适的联合结构拷贝到数据包里面。在读取数据包的时候进行完全相反的操作：读取的数据包的第一个字节，然后根据数据包的类型就能判断出这个数据包还有多少字节没有读取。然后使用<span>memcpy</span>函数将数据包的数据拷贝到合适的联合结构里面。</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">这种方法没有办法更加简化了，所以这就完了么？不完全是这样的！我不推荐这种方法，因为它有一些很讨厌的问题。</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">首先，不同的编译器和平台对于数据结构的打包方式是完全不同的。如果你走这条路的话，你会花很多时间来使用<span>#pragma</span>来努力确保在不同平台的不同的编译器上布局结构在内存中使用完全相同的方式。让这种方式可以在<span>32</span>位和<span>64</span>位架构上都能顺利工作是一个很有<span>“</span>意思<span>”</span>的过程。这并不是说这是不可能的，但它肯定不是一件容易的事情。</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">下一个比较大的问题是字节顺序。现代计算机大多是使用小端这种字节顺序（英特尔的中央处理器都是如此），但<span>PowerPC</span>的内核使用大端这种字节顺序。历史上的网络数据通过用大端这种字节顺序（网络字节顺序）来进行发送，但没有理由让你遵循这一传统。在我的代码里面，我使用的是小端这种字节顺序，这么做的原因是使用这个字节顺序在最常见的平台（英特尔）上在打包和解包中所要做的工作量最少。</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">如果你需要支持使用小端字节顺序的机器和使用大端字节顺序的机器之间进行通信的话，只是使用<span>memcpy</span>函数来将结构体拷贝到数据包的方法根本行不通。你至少需要编写一个函数来在结构被读取以后对它的每个属性的字节顺序进行调整，然后才能顺利的读取和写入。</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">还有一些其他的小问题。很显然，如果你的结构中包含指针，你不能直接把指针进行序列化然后在网络上进行传递然后期望在网络的另外一端反序列化这个指针以后，这个指针在那边还能够正常的使用。另外，如果你有可变大小的结构，比如说一个可以多达<span>32</span>个元素的数组，但是它在大多数时间里面都是空的或者只有很少一些元素，但是为了防止最差的情况你总是需要假设它有<span>32</span>个元素并且进行序列化和反序列化，这非常非常的浪费。一个更好的办法是让你可以对你的可变长度的结构进行编码，能够把长度信息编码到数据结构本身，这样在序列化和反序列化的时候都能妥善处理这个问题。</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">我觉得真正影响这个方法的可用性的最后一个问题是安全性。如果使用这种方法，你相当于直接把整个<span>C++</span>结构中的数据包直接拷贝，然后在网络上进行发送。你到底在想什么？<span>!!</span>如果有人构造了一个恶意的数据包，并把这个包的长度标记为<span>0xFFFFFFFF</span>发送给你的话，这样你在处理这个数据包的时候，将导致你耗费尽所有的内存空间。</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">这是一个巨大的安全风险，让你的原始数据直接在网络上进行传输并且选择相信这些在网络上接收到的数据。。你应该，至少，对这些值进行一个取值范围的检查，让这些值确保落在你期望的范围之内，而不是盲目的相信所有发送给你的数据。</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222"><br></span></p><p class="MsoNormal" align="left" style="line-height: 22.5pt;"><br></p><h2 id="读取和写入函数">读取和写入函数</h2><br><p></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">这个复杂度导致的下一个问题就是每个数据包的读取和写入函数。让我们先从以下几个简单的操作开始：</span> </p><div><div id="highlighter_861556" class="syntaxhighlighter  cpp"><div class="toolbar"><a class="toolbar_item command_help help">?</a></div><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp keyword bold">void</code> <code class="cpp plain">WriteInteger( Buffer &amp; buffer, uint32_t value );</code></div><div class="line number2 index1 alt1"><code class="cpp keyword bold">void</code> <code class="cpp plain">WriteShort( Buffer &amp; buffer, uint16_t value );</code></div><div class="line number3 index2 alt2"><code class="cpp keyword bold">void</code> <code class="cpp plain">WriteChar( Buffer &amp; buffer, uint8_t value );</code></div><div class="line number4 index3 alt1"> </div><div class="line number5 index4 alt2"><code class="cpp plain">uint32_t ReadInteger( Buffer &amp; buffer );</code></div><div class="line number6 index5 alt1"><code class="cpp plain">uint16_t ReadShort( Buffer &amp; buffer );</code></div><div class="line number7 index6 alt2"><code class="cpp plain">uint8_t ReadByte( Buffer &amp; buffer );</code></div></div></td></tr></table></div></div><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222"> </span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">这几个函数是对一个缓冲区结构进行操作，有点类似这样：</span> </p><div><div id="highlighter_449982" class="syntaxhighlighter  cpp"><div class="toolbar"><a class="toolbar_item command_help help">?</a></div><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp keyword bold">struct</code> <code class="cpp plain">Buffer</code></div><div class="line number2 index1 alt1"><code class="cpp plain">{</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">    </code><code class="cpp plain">uint8_t <em> data;     </em></code><code class="cpp comments">// pointer to buffer data</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">    </code><code class="cpp color1 bold">int</code> <code class="cpp plain">size;           </code><code class="cpp comments">// size of buffer data (bytes)</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">    </code><code class="cpp color1 bold">int</code> <code class="cpp plain">index;          </code><code class="cpp comments">// index of next byte to be read/written</code></div><div class="line number6 index5 alt1"><code class="cpp plain">};</code></div></div></td></tr></table></div></div><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><br></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">举个简单的例子来说，写入整数的函数会像是如下这样：</span> </p><div><div id="highlighter_219838" class="syntaxhighlighter  cpp"><div class="toolbar"><a class="toolbar_item command_help help">?</a></div><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp keyword bold">void</code> <code class="cpp plain">WriteInteger( Buffer &amp; buffer, uint32_t value )</code></div><div class="line number2 index1 alt1"><code class="cpp plain">{</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">    </code><code class="cpp functions bold">assert</code><code class="cpp plain">( buffer.index + 4 &lt;= size );</code></div><div class="line number4 index3 alt1"><code class="cpp preprocessor">#ifdef BIG_ENDIAN</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">    </code><code class="cpp plain">((uint32_t<em>)(buffer.data+buffer.index)) = bswap( value ); </em></code></div><div class="line number6 index5 alt1"><code class="cpp preprocessor">#else // #ifdef BIG_ENDIAN</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">    </code><code class="cpp plain">((uint32_t<em>)(buffer.data+buffer.index)) = value; </em></code></div><div class="line number8 index7 alt1"><code class="cpp preprocessor">#endif // #ifdef BIG_ENDIAN</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">    </code><code class="cpp plain">buffer.index += 4;</code></div><div class="line number10 index9 alt1"><code class="cpp plain">}</code></div></div></td></tr></table></div></div><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222"> </span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">而读取整数的函数会像是如下这样：</span> </p><div><div id="highlighter_432752" class="syntaxhighlighter  cpp"><div class="toolbar"><a class="toolbar_item command_help help">?</a></div><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">uint32_t ReadInteger( Buffer &amp; buffer )</code></div><div class="line number2 index1 alt1"><code class="cpp plain">{</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">    </code><code class="cpp functions bold">assert</code><code class="cpp plain">( buffer.index + 4 &lt;= size );</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">    </code><code class="cpp plain">uint32_t value;</code></div><div class="line number5 index4 alt2"><code class="cpp preprocessor">#ifdef BIG_ENDIAN</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">    </code><code class="cpp plain">value = bswap( ((uint32_t<em>)(buffer.data+buffer.index)) );</em></code></div><div class="line number7 index6 alt2"><code class="cpp preprocessor">#else // #ifdef BIG_ENDIAN</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">    </code><code class="cpp plain">value = ((uint32_t<em>)(buffer.data+buffer.index));</em></code></div><div class="line number9 index8 alt2"><code class="cpp preprocessor">#endif // #ifdef BIG_ENDIAN</code></div><div class="line number10 index9 alt1"><code class="cpp spaces">    </code><code class="cpp plain">buffer.index += 4;</code></div><div class="line number11 index10 alt2"><code class="cpp spaces">    </code><code class="cpp keyword bold">return</code> <code class="cpp plain">value;</code></div><div class="line number12 index11 alt1"><code class="cpp plain">}</code></div></div></td></tr></table></div></div><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222"> </span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">现在就不仅仅是直接使用<span>memcpy</span>函数把内存中的数据结构直接拷贝到数据包里面，而是为每个数据包类型使用了单独的读取和写入函数：</span><span style="color: rgb(34, 34, 34); font-family: 微软雅黑, sans-serif; font-size: 12pt;"> </span></p><div><div id="highlighter_690559" class="syntaxhighlighter  cpp"><div class="toolbar"><a class="toolbar_item command_help help">?</a></div><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div><div class="line number40 index39 alt1">40</div><div class="line number41 index40 alt2">41</div><div class="line number42 index41 alt1">42</div><div class="line number43 index42 alt2">43</div><div class="line number44 index43 alt1">44</div><div class="line number45 index44 alt2">45</div><div class="line number46 index45 alt1">46</div><div class="line number47 index46 alt2">47</div><div class="line number48 index47 alt1">48</div><div class="line number49 index48 alt2">49</div><div class="line number50 index49 alt1">50</div><div class="line number51 index50 alt2">51</div><div class="line number52 index51 alt1">52</div><div class="line number53 index52 alt2">53</div><div class="line number54 index53 alt1">54</div><div class="line number55 index54 alt2">55</div><div class="line number56 index55 alt1">56</div><div class="line number57 index56 alt2">57</div><div class="line number58 index57 alt1">58</div><div class="line number59 index58 alt2">59</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp keyword bold">struct</code> <code class="cpp plain">PacketA</code></div><div class="line number2 index1 alt1"><code class="cpp plain">{</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">    </code><code class="cpp color1 bold">int</code> <code class="cpp plain">x,y,z;</code></div><div class="line number4 index3 alt1"> </div><div class="line number5 index4 alt2"><code class="cpp spaces">    </code><code class="cpp keyword bold">void</code> <code class="cpp plain">Write( Buffer &amp; buffer )</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">    </code><code class="cpp plain">{</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">        </code><code class="cpp plain">WriteInteger( buffer, x );</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">        </code><code class="cpp plain">WriteInteger( buffer, y );</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">        </code><code class="cpp plain">WriteInteger( buffer, z );</code></div><div class="line number10 index9 alt1"><code class="cpp spaces">    </code><code class="cpp plain">}</code></div><div class="line number11 index10 alt2"> </div><div class="line number12 index11 alt1"><code class="cpp spaces">    </code><code class="cpp keyword bold">void</code> <code class="cpp plain">Read( Buffer &amp; buffer )</code></div><div class="line number13 index12 alt2"><code class="cpp spaces">    </code><code class="cpp plain">{</code></div><div class="line number14 index13 alt1"><code class="cpp spaces">        </code><code class="cpp plain">ReadInteger( buffer, x );</code></div><div class="line number15 index14 alt2"><code class="cpp spaces">        </code><code class="cpp plain">ReadInteger( buffer, y );</code></div><div class="line number16 index15 alt1"><code class="cpp spaces">        </code><code class="cpp plain">ReadInteger( buffer, z ); </code></div><div class="line number17 index16 alt2"><code class="cpp spaces">    </code><code class="cpp plain">}</code></div><div class="line number18 index17 alt1"><code class="cpp plain">};</code></div><div class="line number19 index18 alt2"> </div><div class="line number20 index19 alt1"><code class="cpp keyword bold">struct</code> <code class="cpp plain">PacketB</code></div><div class="line number21 index20 alt2"><code class="cpp plain">{</code></div><div class="line number22 index21 alt1"><code class="cpp spaces">    </code><code class="cpp color1 bold">int</code> <code class="cpp plain">numElements;</code></div><div class="line number23 index22 alt2"><code class="cpp spaces">    </code><code class="cpp color1 bold">int</code> <code class="cpp plain">elements[MaxElements];</code></div><div class="line number24 index23 alt1"> </div><div class="line number25 index24 alt2"><code class="cpp spaces">    </code><code class="cpp keyword bold">void</code> <code class="cpp plain">Write( Buffer &amp; buffer )</code></div><div class="line number26 index25 alt1"><code class="cpp spaces">    </code><code class="cpp plain">{</code></div><div class="line number27 index26 alt2"><code class="cpp spaces">        </code><code class="cpp plain">WriteInteger( buffer, numElements );</code></div><div class="line number28 index27 alt1"><code class="cpp spaces">        </code><code class="cpp keyword bold">for</code> <code class="cpp plain">( </code><code class="cpp color1 bold">int</code> <code class="cpp plain">i = 0; i &lt; numElements; ++i )</code></div><div class="line number29 index28 alt2"><code class="cpp spaces">            </code><code class="cpp plain">WriteInteger( buffer, elements[i] );</code></div><div class="line number30 index29 alt1"><code class="cpp spaces">    </code><code class="cpp plain">}</code></div><div class="line number31 index30 alt2"> </div><div class="line number32 index31 alt1"><code class="cpp spaces">    </code><code class="cpp keyword bold">void</code> <code class="cpp plain">Read( Buffer &amp; buffer )</code></div><div class="line number33 index32 alt2"><code class="cpp spaces">    </code><code class="cpp plain">{</code></div><div class="line number34 index33 alt1"><code class="cpp spaces">        </code><code class="cpp plain">ReadInteger( buffer, numElements );</code></div><div class="line number35 index34 alt2"><code class="cpp spaces">        </code><code class="cpp keyword bold">for</code> <code class="cpp plain">( </code><code class="cpp color1 bold">int</code> <code class="cpp plain">i = 0; i &lt; numElements; ++i )</code></div><div class="line number36 index35 alt1"><code class="cpp spaces">            </code><code class="cpp plain">ReadInteger( buffer, elements[i] );</code></div><div class="line number37 index36 alt2"><code class="cpp spaces">    </code><code class="cpp plain">}</code></div><div class="line number38 index37 alt1"><code class="cpp plain">};</code></div><div class="line number39 index38 alt2"> </div><div class="line number40 index39 alt1"><code class="cpp keyword bold">struct</code> <code class="cpp plain">PacketC</code></div><div class="line number41 index40 alt2"><code class="cpp plain">{</code></div><div class="line number42 index41 alt1"><code class="cpp spaces">    </code><code class="cpp color1 bold">bool</code> <code class="cpp plain">x;</code></div><div class="line number43 index42 alt2"><code class="cpp spaces">    </code><code class="cpp color1 bold">short</code> <code class="cpp plain">y;</code></div><div class="line number44 index43 alt1"><code class="cpp spaces">    </code><code class="cpp color1 bold">int</code> <code class="cpp plain">z;</code></div><div class="line number45 index44 alt2"> </div><div class="line number46 index45 alt1"><code class="cpp spaces">    </code><code class="cpp keyword bold">void</code> <code class="cpp plain">Write( Buffer &amp; buffer )</code></div><div class="line number47 index46 alt2"><code class="cpp spaces">    </code><code class="cpp plain">{</code></div><div class="line number48 index47 alt1"><code class="cpp spaces">        </code><code class="cpp plain">WriteByte( buffer, x );</code></div><div class="line number49 index48 alt2"><code class="cpp spaces">        </code><code class="cpp plain">WriteShort( buffer, y );</code></div><div class="line number50 index49 alt1"><code class="cpp spaces">        </code><code class="cpp plain">WriteInt( buffer, z );</code></div><div class="line number51 index50 alt2"><code class="cpp spaces">    </code><code class="cpp plain">}</code></div><div class="line number52 index51 alt1"> </div><div class="line number53 index52 alt2"><code class="cpp spaces">    </code><code class="cpp keyword bold">void</code> <code class="cpp plain">Read( Buffer &amp; buffer )</code></div><div class="line number54 index53 alt1"><code class="cpp spaces">    </code><code class="cpp plain">{</code></div><div class="line number55 index54 alt2"><code class="cpp spaces">        </code><code class="cpp plain">ReadByte( buffer, x );</code></div><div class="line number56 index55 alt1"><code class="cpp spaces">        </code><code class="cpp plain">ReadShort( buffer, y );</code></div><div class="line number57 index56 alt2"><code class="cpp spaces">        </code><code class="cpp plain">ReadInt( buffer, z );</code></div><div class="line number58 index57 alt1"><code class="cpp spaces">    </code><code class="cpp plain">}</code></div><div class="line number59 index58 alt2"><code class="cpp plain">};</code></div></div></td></tr></table></div></div><br><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222"> </span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">当对数据包进行读取和写入的时候，通过<span>ReadByte / WriteByte</span>函数来在数据包的数据之前加上一个字节，用来表明数据包的类型，然后根据数据包的类型，调用联合体里面对应数据包结构里面读取或者写入函数。</span><span style="font-family:&quot;inherit&quot;,&quot;serif&quot;;color:#212121">  </span><span><br></span><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">所以，现在我们有了一个简单的系统，允许使用不同的字节顺序的机器可以进行通信，并支持可变长度的编码。举个简单的例子来说，现在可以对数组的长度进行序列化并且只对存在的数据进行遍历和序列化，而不用像以前那样，总是要按照最坏情况来发送整个队列。</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222"><br></span></p><p class="MsoNormal" align="left" style="line-height: 22.5pt;"><br></p><h2 id="读取和写入函数存在的问题">读取和写入函数存在的问题</h2><br><p></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">有了读取和写入函数，是相比较之前的<span>memcpy</span>方法进行数据包的打包和解包前进了一大步，但是这种方法也存在一些问题。让我们一起看下具体都有些什么问题。</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">第一个存在的问题：如果有一个值，它的取值范围是【<span>0</span>，<span>100</span>】，那么它只需要<span>10</span>个比特就能表示所有可能的值，但是因为我们只能序列化一个字节的值【<span>0</span>，<span>255</span>】，一个<span>short</span>类型的整数【<span>0,655325</span>】或者是一个<span>32</span>比特的整数【<span>0</span>，<span>2^32-1</span>】，所以我们必须凑够<span>16</span>位。这样的话就浪费了<span>6</span>位！</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">同样的，如果是一个布尔值（只有真和假两种情况）只需要一位就能表示，但是它们必须取整为一个字节，这就浪费了<span>7</span>位！现在你可以通过用<span>C++</span>结构来实现你的数据包以及对<span>C++</span>的位域进行序列化并使用一些联合方面的技巧来对这个值进行取整，但是你真的能保证两个完全不同的<span>C ++</span>编译器用完全相同的方式来在内存对位域进行打包？据我所知，应该是不可能的。</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">第二个存在的问题：怀有恶意的人仍然可以构造一个恶意的数据包。举个简单的例子来说，让我们假设<span>MaxElements</span>是<span>32</span>，所以数据包<span>PacketB</span>的元素的数目肯定是在范围【<span>0</span>，<span>32</span>】之间。由于我们是在字节级别对数据包进行读取和吸入，所以元素的数目是存在一个字节里面，可能的取值范围是【<span>0</span>，<span>255</span>】。这导致字节里面【<span>33,255</span>】这个范围的值是完全没有定义的。</span> </p><p class="MsoNormal" align="left"><span><br></span><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">如果有人构造了一个<span>elementCount = 255</span>的恶意的数据包，会发生什么？会发生内存崩溃！当然你可以手动设置一个阈值，对读入的数据的大小进行限制，或者手动对它们进行检查，如果出现问题就中止读取，但是你真正想要的一个知道每个要读取的域的最小<span>/</span>最大值到底是多少的系统，并且在任何数据包中对应的值如果超出预期的范围就会自动中止读取，这样在你的代码看到这些不合法的值之前，这些值就已经被丢弃了。<span><br></span>在我看来，最后一个存在的问题是，维护这些单独的读取和写入函数真的很让人讨厌。随着这些函数变得越来越复杂，它很容易对其中一个函数进行改变而忘记相应的改变另外一个函数（读取和写入函数是成对出现的，如果要改变一个的话，需要同时改变另外一个，要么就会出现问题，发送方和写入方根本就没法正确的得到数据包里面的信息）。导致之间的读写不同步。而这些不同步可能非常难以追查。</span> </p><p class="MsoNormal" align="left" style="background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial;"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">我们要解决所有这些问题，但是首先我们要通过实现一个位打包器来朝这个方向努力，这样我们才不会继续浪费位来存储一些没必要的数据。</span> </p><p class="MsoNormal" align="left" style="background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial;"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222"><br></span></p><br><h2 id="实现一个位打包器">实现一个位打包器</h2><br><p class="MsoNormal" align="left" style="background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial;"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">如果我们要在数据包写入一个布尔值的话，它应该只需要在数据包里面占据一个位的大小。如果我们要在数据包写入一个取值范围在【<span>0</span>，<span>31</span>】的值，它应该在数据包里面占据五个位的大小，而不是八个位的大小。如果我们要在数据包写入一个取值范围在【<span>0</span>，<span>100000</span>】的值，它应该在数据包里面占据十七位的大小，而不是二十四位的大小或者三十二位的大小。要做到这一点，我们需要写一个位打包器。</span> </p><p style="margin: 6pt 0cm; line-height: 16.8pt; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial;"><span style="font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">很多人所写的位打包器是工作在字节这个级别上的，举个例子来说明的话就是他们会把生成的字节刷新到流里面，但是我不喜欢这种方法，因为如果它们是工作在word这个级别的话会快的多。我的目标是每次是写下很多word的时候（<span>32</span>位或者<span>64</span>位），然后每次读取<span>32</span>位或者<span>64</span>位，因为现代机器对这个长度进行了专门的优化而不应该像<span>1985</span>年那样在字节的级别对缓冲区进行处理。</span> </p><p style="margin: 6pt 0cm; line-height: 16.8pt; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial;"><span style="font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">我的位打包技术的原理是类似这样的：如果你想在一次在数据包写入<span>32</span>位的话，你需要一个两倍大小的临时word，比如说<span>uint64_t</span>。如果你想在一次在数据包写入<span>64</span>位的话，你需要<span>128</span>位。这样做的原因是你需要整个区域的上半部分进行溢出，因为你可以只写一个<span>30</span>位大小的值到临时缓冲区，然后需要写入一个<span>10</span>位大小的值到临时缓冲区中。如果这个临时字的上半部分没有额外的空间的话，你需要额外的分支和逻辑来处理溢出情况。既然你想在位打包里面的循环里面产生尽可能少的分支，那么这种方法将有很大的意义。</span> </p><br><h2 id="以位来写入数据包">以位来写入数据包</h2><br><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">对于位打包器的数据吸入，你需要一些缓冲区以及一个变量来记录目前在缓冲区里面的位的数目。在这个例子之中，让我们把字长选为<span>32</span>位，这样，位打包器的变量看上去就会像是这样：</span> </p><div><div id="highlighter_884719" class="syntaxhighlighter  cpp"><div class="toolbar"><a class="toolbar_item command_help help">?</a></div><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">uint64_t scratch;</code></div><div class="line number2 index1 alt1"><code class="cpp color1 bold">int</code> <code class="cpp plain">scratch_bits;</code></div><div class="line number3 index2 alt2"><code class="cpp color1 bold">int</code> <code class="cpp plain">word_index;</code></div><div class="line number4 index3 alt1"><code class="cpp plain">uint32_t  buffer;</code></div></div></td></tr></table></div></div><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222"> </span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">当你开始启动你的位打包器进行写入的时候，所有这些变量都将被清零，缓冲区的指针会指向缓冲区的起始位置，这个指针用于数据包实际开始写入的位置指示。这个缓冲区的长度是以字节为单位的，必须要是<span>4</span>的整数倍，因为我们工作的字长是<span>32</span>位。</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">比方说，我们要写入<span>3</span>位数据，然后是<span>10</span>位数据，再然后是<span>24</span>位数据。你的目标是在临时缓冲区对这块数据使用一个比较紧密的打包方式并把整理好的数据刷新到内存中去，一次是<span>32</span>位（一个字长）。需要注意的是<span>3 + 10 + 24 = 37</span>，这是故意设计的。你必须处理这种情况。</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">在第一步中，向临时缓冲区写入<span>3</span>位数据就像下面这样：</span> </p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">xxx</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">临时缓冲区的长度现在就是<span>3</span>位。</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">接下来，向临时缓冲区写入<span>10</span>位数据就像下面这样：</span> </p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">yyyyyyyyyyxxx</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">临时缓冲区的长度现在就是<span>13</span>位（<span>10+3</span>）。<span><br></span>为什么要以这种方式进行打包而不是使用<span>xxxyyyyyyyyyy</span>这种方式？我用这种字节顺序写入的原因是因为我用小端字节顺序来存储网络数据。如果我没有按照这个方向对位数据进行存储的话，那么在发送数据包的时候我将不得不将数据包的大小对齐到下一个双字的长度那里，或者我只能对我的数据包的尾端进行截断。如果你想以大端字节顺序来发送刷新的数据的话，你应该按照另外一个方向对数据包的数据进行打包。</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">接下来，向临时缓冲区写入<span>24</span>位数据就像下面这样：</span> </p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">zzzzzzzzzzzzzzzzzzzzzzzzyyyyyyyyyyxxx</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">临时缓冲区的长度现在就是<span>37</span>位（<span>10+3+24</span>）。我们正在跨越<span>32</span>位字的边界，并有<span>5</span>位会写入到<span>uint64_t</span>结构的上半<span>32</span>位中（所以这实际是一个溢出）。现在<span>bit_index &gt;= 32</span>，刷新低<span>32</span>位的数据到内存中去，并对<span>word_index</span>加<span>1</span>，然后从临时缓冲区的长度减去<span>32</span>并向对临时缓冲区向右偏移<span>32</span>位。</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222"> </span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">临时缓冲区现在看上去就像是下面这样：</span> </p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">zzzzz</span> </p><span style="font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">我们可以继续下去，但是我们决定在停下来对这一点进行解释。我们必须在整个数据包的最后放置的是一个<span>32</span>位的字。对字这个级别进行处理的位打包器的一个微妙的一点是你需要在整体写入的最后进行一个刷新处理，这样才能保证最后的这些位会写入到内存中去。当我们把一个字刷新到内存中去的时候，我们要确保这个字会被正确的转换成小端字节顺序。举个简单的例子来说：ＡＢＣＤ当被写入内存中的时候需要被有效的转换成ＤＣＢＡ这个顺序。</span><span style="font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">如果要想明白为什么这种做法非常重要，需要考虑下如果我们用大端字节顺序来把字刷新到内存中去会发生什么事情？最后一个字会截断，因为这个字会以在整数相同的字节顺序写入到内存中去。因为我们会把开始的那些位写到字的低的那个字节中去，我们的内存中的顺序看上去是这样的：对于刚才那串比特值，写入内存的时候会是ＡＢＣＤＥ这个顺序。</span><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt 18pt 0cm;"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">DCBA000E</span><span style="font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222"><br></span><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">现在，如果我们尝试以５个字节的大小来用一个数据包来发送缓冲区（我们要发送的数据的实际大小）它捕获的最后一个字节会是０而不是Ｅ。（作者在这里打了一个笑脸）。</span> </p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt 18pt 0cm;"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">但是，当我们以小端这种字节顺序把上面的内容写入内存的时候，字节在内存中的布局是这样的：</span> </p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt 18pt 0cm;"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">ABCDE000</span> </p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt 18pt 0cm;"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">我们可以只在网络上写<span>5</span>个字节，这样就节省了<span>3</span>个字节，并且仍然是以Ｅ来作为数据包的结尾。</span> </p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt 18pt 0cm;"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">实际上，我们所做的是开关字周围的字节，因为我们通过这种方法进行构造来避免小端字节顺序的重新排序，所以我们希望是以它们在内存中的顺序直接写入到网络的数据包中，字节顺序是很难处理的。</span> </p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt 18pt 0cm;"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222"><br></span></p><p class="MsoNormal" align="left" style="line-height: 22.5pt;"><br><br>其代码类似于 ：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BitWriter</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">    BitWriter( <span class="keyword">void</span>* data, <span class="keyword">int</span> bytes ) </span><br><span class="line">        : m_data( (<span class="keyword">uint32_t</span>*)data ), m_numWords( bytes / <span class="number">4</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        assert( data );</span><br><span class="line">        assert( ( bytes % <span class="number">4</span> ) == <span class="number">0</span> );           <span class="comment">// buffer size must be a multiple of four</span></span><br><span class="line">        m_numBits = m_numWords * <span class="number">32</span>;</span><br><span class="line">        m_bitsWritten = <span class="number">0</span>;</span><br><span class="line">        m_wordIndex = <span class="number">0</span>;</span><br><span class="line">        m_scratch = <span class="number">0</span>;</span><br><span class="line">        m_scratchBits = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">WriteBits</span><span class="params">( <span class="keyword">uint32_t</span> value, <span class="keyword">int</span> bits )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        assert( bits &gt; <span class="number">0</span> );</span><br><span class="line">        assert( bits &lt;= <span class="number">32</span> );</span><br><span class="line">        assert( m_bitsWritten + bits &lt;= m_numBits );</span><br><span class="line"></span><br><span class="line">        value &amp;= ( <span class="keyword">uint64_t</span>(<span class="number">1</span>) &lt;&lt; bits ) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        m_scratch |= <span class="keyword">uint64_t</span>( value ) &lt;&lt; m_scratchBits;</span><br><span class="line"></span><br><span class="line">        m_scratchBits += bits;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( m_scratchBits &gt;= <span class="number">32</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            assert( m_wordIndex &lt; m_numWords );</span><br><span class="line">            m_data[m_wordIndex] = host_to_network( <span class="keyword">uint32_t</span>( m_scratch &amp; <span class="number">0xFFFFFFFF</span> ) );</span><br><span class="line">            m_scratch &gt;&gt;= <span class="number">32</span>;</span><br><span class="line">            m_scratchBits -= <span class="number">32</span>;</span><br><span class="line">            m_wordIndex++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        m_bitsWritten += bits;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">WriteAlign</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">int</span> remainderBits = m_bitsWritten % <span class="number">8</span>;</span><br><span class="line">        <span class="keyword">if</span> ( remainderBits != <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">uint32_t</span> zero = <span class="number">0</span>;</span><br><span class="line">            WriteBits( zero, <span class="number">8</span> - remainderBits );</span><br><span class="line">            assert( ( m_bitsWritten % <span class="number">8</span> ) == <span class="number">0</span> );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">WriteBytes</span><span class="params">( <span class="keyword">const</span> <span class="keyword">uint8_t</span>* data, <span class="keyword">int</span> bytes )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        assert( GetAlignBits() == <span class="number">0</span> );</span><br><span class="line">        assert( m_bitsWritten + bytes * <span class="number">8</span> &lt;= m_numBits );</span><br><span class="line">        assert( ( m_bitsWritten % <span class="number">32</span> ) == <span class="number">0</span> || ( m_bitsWritten % <span class="number">32</span> ) == <span class="number">8</span> || ( m_bitsWritten % <span class="number">32</span> ) == <span class="number">16</span> || ( m_bitsWritten % <span class="number">32</span> ) == <span class="number">24</span> );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> headBytes = ( <span class="number">4</span> - ( m_bitsWritten % <span class="number">32</span> ) / <span class="number">8</span> ) % <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">if</span> ( headBytes &gt; bytes )</span><br><span class="line">            headBytes = bytes;</span><br><span class="line">        <span class="keyword">for</span> ( <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; headBytes; ++i )</span><br><span class="line">            WriteBits( data[i], <span class="number">8</span> );</span><br><span class="line">        <span class="keyword">if</span> ( headBytes == bytes )</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        FlushBits();</span><br><span class="line"></span><br><span class="line">        assert( GetAlignBits() == <span class="number">0</span> );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> numWords = ( bytes - headBytes ) / <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">if</span> ( numWords &gt; <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            assert( ( m_bitsWritten % <span class="number">32</span> ) == <span class="number">0</span> );</span><br><span class="line">            <span class="built_in">memcpy</span>( &amp;m_data[m_wordIndex], data + headBytes, numWords * <span class="number">4</span> );</span><br><span class="line">            m_bitsWritten += numWords * <span class="number">32</span>;</span><br><span class="line">            m_wordIndex += numWords;</span><br><span class="line">            m_scratch = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        assert( GetAlignBits() == <span class="number">0</span> );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> tailStart = headBytes + numWords * <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">int</span> tailBytes = bytes - tailStart;</span><br><span class="line">        assert( tailBytes &gt;= <span class="number">0</span> &amp;&amp; tailBytes &lt; <span class="number">4</span> );</span><br><span class="line">        <span class="keyword">for</span> ( <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tailBytes; ++i )</span><br><span class="line">            WriteBits( data[tailStart+i], <span class="number">8</span> );</span><br><span class="line"></span><br><span class="line">        assert( GetAlignBits() == <span class="number">0</span> );</span><br><span class="line"></span><br><span class="line">        assert( headBytes + numWords * <span class="number">4</span> + tailBytes == bytes );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">FlushBits</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ( m_scratchBits != <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            assert( m_wordIndex &lt; m_numWords );</span><br><span class="line">            m_data[m_wordIndex] = host_to_network( <span class="keyword">uint32_t</span>( m_scratch &amp; <span class="number">0xFFFFFFFF</span> ) );</span><br><span class="line">            m_scratch &gt;&gt;= <span class="number">32</span>;</span><br><span class="line">            m_scratchBits -= <span class="number">32</span>;</span><br><span class="line">            m_wordIndex++;                </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">GetAlignBits</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ( <span class="number">8</span> - ( m_bitsWritten % <span class="number">8</span> ) ) % <span class="number">8</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">GetBitsWritten</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> m_bitsWritten;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">GetBitsAvailable</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> m_numBits - m_bitsWritten;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">const</span> uint8_t* <span class="title">GetData</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">uint8_t</span>*) m_data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">GetBytesWritten</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ( m_bitsWritten + <span class="number">7</span> ) / <span class="number">8</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">GetTotalBytes</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> m_numWords * <span class="number">4</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span>* m_data;</span><br><span class="line">    <span class="keyword">uint64_t</span> m_scratch;</span><br><span class="line">    <span class="keyword">int</span> m_numBits;</span><br><span class="line">    <span class="keyword">int</span> m_numWords;</span><br><span class="line">    <span class="keyword">int</span> m_bitsWritten;</span><br><span class="line">    <span class="keyword">int</span> m_wordIndex;</span><br><span class="line">    <span class="keyword">int</span> m_scratchBits;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><br><br></p><h2 id="以位来读取数据包">以位来读取数据包</h2><br><p></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">我们该如何在网络的另外一侧读取已经通过位打包器打包好的数据？</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">要我们从要在网络上进行发送的缓冲区开始，假设我们刚刚从<span>recvfrom.</span>函数返回。它里面的内容有５位这么长。</span> </p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">ABCDE</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">因为我们是按照字这个等级进行读取，我们必须要把数据的长度截断到双字这个长度，比如说８个字节：</span> </p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">ABCDE000</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">现在，这里有一点很微妙的地方。当我在网络上发送一个数据包的时候，我真的不知道它到底包含了多少位的数据（否则的话我将不得不将这个数据包的大小直接记录在数据包的包头里面），而且这是一个带宽的浪费。但是通过在网络的另外一侧使用<span>recvfrom</span>函数我确实知道到底这个数据包的内容的长度是多少，因此当５个字节大小的数据包从网络上到达的时候，我可以直接认为缓冲区中的位的大小是数据包字节大小乘以８。因此，实际上，位读取器认为这个分组中要被读取的比特数为<span>5 <em> 8 = 40</em></span>，而不是<span>37</span>。</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">你真的想在这里做的事情是确保如果位读取器读取的位置已经超过缓冲区实际位数的结尾，在这个例子中，就是发送的３７位数据，那么它将读取的是零而不是未定义数据。这会自动发生在数据包最后一个字节的最后<span>3</span>位上，因为它们是由位写入器写入的零，但是对于在缓冲区中的最后<span>3</span>个比特你必须确保它们被读为零，以及未来的任何可能位的读取也是返回零。这是一个非常重要的安全步骤以防止你读取的时候超过缓冲区或者数据流的结尾。</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">现在让我们开始吧。你将在位读取器里面有如下这些变量：</span> </p><div><div id="highlighter_328289" class="syntaxhighlighter  cpp"><div class="toolbar"><a class="toolbar_item command_help help">?</a></div><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">uint64_t scratch;</code></div><div class="line number2 index1 alt1"><code class="cpp color1 bold">int</code> <code class="cpp plain">scratch_bits;</code></div><div class="line number3 index2 alt2"><code class="cpp color1 bold">int</code> <code class="cpp plain">total_bits;</code></div><div class="line number4 index3 alt1"><code class="cpp color1 bold">int</code> <code class="cpp plain">num_bits_read;</code></div><div class="line number5 index4 alt2"><code class="cpp color1 bold">int</code> <code class="cpp plain">word_index;</code></div><div class="line number6 index5 alt1"><code class="cpp plain">uint32_t  buffer;</code></div></div></td></tr></table></div></div><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><br></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">这比位写入器要复杂一些，因为你需要做更多的检测。但是请记住，永远不要相信来自客户端的数据。</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">要开始进行读取的时候，字的序号是０，临时缓冲区的内容和临时缓冲区的位数都是０。</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">然后用户请求３位的空间。因为临时缓冲区的位数现在是０，现在是时候来读取第一个字了。读取第一个字然后把它放到临时缓冲区，并对临时缓冲区的位数（目前是<span>0</span>）向右进行偏移。把临时缓冲区的位数添加<span>32</span>。</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">现在通过把临时缓冲区的内容拷贝到另外一个变量里面来读取前面的<span>3</span>位并通过<span>&amp; ( (1&lt;&lt;3 ) – 1 )</span>进行遮罩处理，来给出最后输出的结果：</span> </p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">xxx</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">现在将临时缓冲区的内容向右偏移<span>3</span>位，并从临时缓冲区的位数中减去<span>3</span>：</span> </p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">zzzzzzzzzzzzzzzzzzzyyyyyyyyyy</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">现在用完全相同的办法读取后面的<span>10</span>位。临时缓冲区看上去就是下面这样的：</span> </p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">zzzzzzzzzzzzzzzzzzz</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">恩。接下来的读取调用请求<span>24</span>位数据的内容，但是临时缓冲区的位数只有<span>19</span>了（<span>19 = 32-10-3 </span>）。。。现在是时候来读取下一个字了。这个字多半是零因为我们已经对它们进行了清除，但是它还有多余的<span>5</span>位我们需要在接下来进行读取。现在我们准备读取临时缓冲区里面有关<span>z</span>的比特位了：</span> </p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">zzzzzzzzzzzzzzzzzzzzzzzz</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">接下来读取<span>24</span>位并向右位移<span>24</span>位。临时缓冲区现在全部都是<span>0</span>了。</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">理论上位读取器认为还有<span>27</span>位数据留在缓冲区没有进行读取，如果我们继续进行读取的话，这些位会被作为零弹出来，因为最后一个字节的前<span>3</span>位是零，并且我们把临时缓冲区的最后<span>3</span>个字节全部清位<span>0</span>，因为我们为了按照字进行对齐。（为了对齐，所以填充了<span>3</span>个全部是<span>0</span>的字节。所以位读取器这时候看的话还有<span>3</span>个完整的字节没有读。）</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">但是让我们假设，由于某种原因，越过了这个点以后用户还是一直尝试进行读取。为了处理这种情况，检查缓冲区中你需要读取的字的数目，以及每次你需要从缓冲区实际读取的字的情况。如果你已经读完了要读的字以后，不要继续增加<span>word_index</span>并继续读取数据这会让你的内存崩溃的，给你的缓冲区填充<span>0</span>来对齐并在缓冲区的位数添加<span>32</span>在每次给缓冲区的末尾添加一个新的字的情况下。通过这种方法，在读取位数的每次内部循环调用的时候能确保分支最后总是返回零，并把它放在你每次需要读取一个新字的地方，但是你读取的位置已经超过了缓冲区结尾的地方你仍然是安全的并且返回<span>0</span>个比特。</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">这似乎有点过于谨慎了，但是在对网络数据进行读取的时候这种谨慎是特别重要的。这是通过网络传输过来的数据。不要相信它们！如果你的读取和写入是不同步的，或者有人给你发送了一个恶意的缓冲区数据，你可能会被困在一个循环里面并不断尝试读取数据。确保内部循环里面所有的遍历里面的读取都会检测缓冲区是否溢出或者有损坏，如果用户读取的位置已经超出了缓冲区的结尾这种策略总是返回定义的值（<span>0</span>），通过这种行为你可以确保大多数情况都是符合预期的。</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222"><br></span></p><p class="MsoNormal" align="left" style="line-height: 22.5pt;"><br>其代码类似于：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BitReader</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span> ReadBits( <span class="keyword">int</span> bits )</span><br><span class="line">    &#123;</span><br><span class="line">        assert( bits &gt; <span class="number">0</span> );</span><br><span class="line">        assert( bits &lt;= <span class="number">32</span> );</span><br><span class="line">        assert( m_bitsRead + bits &lt;= m_numBits );</span><br><span class="line"></span><br><span class="line">        m_bitsRead += bits;</span><br><span class="line"></span><br><span class="line">        assert( m_scratchBits &gt;= <span class="number">0</span> &amp;&amp; m_scratchBits &lt;= <span class="number">64</span> );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( m_scratchBits &lt; bits )</span><br><span class="line">        &#123;</span><br><span class="line">            assert( m_wordIndex &lt; m_numWords );</span><br><span class="line">            m_scratch |= <span class="keyword">uint64_t</span>( network_to_host( m_data[m_wordIndex] ) ) &lt;&lt; m_scratchBits;</span><br><span class="line">            m_scratchBits += <span class="number">32</span>;</span><br><span class="line">            m_wordIndex++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        assert( m_scratchBits &gt;= bits );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">uint32_t</span> output = m_scratch &amp; ( (<span class="keyword">uint64_t</span>(<span class="number">1</span>)&lt;&lt;bits) - <span class="number">1</span> );</span><br><span class="line"></span><br><span class="line">        m_scratch &gt;&gt;= bits;</span><br><span class="line">        m_scratchBits -= bits;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> output;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><br></p><h2 id="如何使位打包器更棒">如何使位打包器更棒</h2><br><p></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">位打包器这种方法非常的棒，但是直接用于读取和写入数据包时，这并不是最有用的方法。我见过有团队直接使用位打包器进行读取和写入数据包，但是这并不是最佳的方法。你会拥有很多复杂的代码，并且非常容易出错。</span> </p><span style="font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">让我们一起看下这个例子：</span> <div><div id="highlighter_384924" class="syntaxhighlighter  cpp"><div class="toolbar"><a class="toolbar_item command_help help">?</a></div><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp keyword bold">const</code> <code class="cpp color1 bold">int</code> <code class="cpp plain">MaxElements = 32;</code></div><div class="line number2 index1 alt1"> </div><div class="line number3 index2 alt2"><code class="cpp keyword bold">struct</code> <code class="cpp plain">PacketB</code></div><div class="line number4 index3 alt1"><code class="cpp plain">{</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">    </code><code class="cpp color1 bold">int</code> <code class="cpp plain">numElements;</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">    </code><code class="cpp color1 bold">int</code> <code class="cpp plain">elements[MaxElements];</code></div><div class="line number7 index6 alt2"> </div><div class="line number8 index7 alt1"><code class="cpp spaces">    </code><code class="cpp keyword bold">void</code> <code class="cpp plain">Write( BitWriter &amp; writer )</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">    </code><code class="cpp plain">{</code></div><div class="line number10 index9 alt1"><code class="cpp spaces">        </code><code class="cpp plain">WriteBits( writer, numElements, 6 );</code></div><div class="line number11 index10 alt2"><code class="cpp spaces">        </code><code class="cpp keyword bold">for</code> <code class="cpp plain">( </code><code class="cpp color1 bold">int</code> <code class="cpp plain">i = 0; i &lt; numElements; ++i )</code></div><div class="line number12 index11 alt1"><code class="cpp spaces">            </code><code class="cpp plain">WriteBits( writer, elements[i] );</code></div><div class="line number13 index12 alt2"><code class="cpp spaces">    </code><code class="cpp plain">}</code></div><div class="line number14 index13 alt1"> </div><div class="line number15 index14 alt2"><code class="cpp spaces">    </code><code class="cpp keyword bold">void</code> <code class="cpp plain">Read( BitReader &amp; reader )</code></div><div class="line number16 index15 alt1"><code class="cpp spaces">    </code><code class="cpp plain">{</code></div><div class="line number17 index16 alt2"><code class="cpp spaces">        </code><code class="cpp plain">ReadBits( reader, numElements, 6 );</code></div><div class="line number18 index17 alt1"><code class="cpp spaces">        </code><code class="cpp keyword bold">for</code> <code class="cpp plain">( </code><code class="cpp color1 bold">int</code> <code class="cpp plain">i = 0; i &lt; numElements; ++i )</code></div><div class="line number19 index18 alt2"><code class="cpp spaces">            </code><code class="cpp plain">ReadBits( reader, elements[i] );</code></div><div class="line number20 index19 alt1"><code class="cpp spaces">    </code><code class="cpp plain">}</code></div><div class="line number21 index20 alt2"><code class="cpp plain">};</code></div><div class="line number21 index20 alt2"><code class="cpp plain"><br></code></div></div></td></tr></table></div></div><span style="color: rgb(34, 34, 34);"><span style="font-family:微软雅黑;font-size:medium;">第一种方法很容易出错，让我们假设在一段时间以后，你把<span>MaxElements</span>的值从<span>32</span>提高到<span>100</span>，但是你没有修改需要序列化的比特的数目，也就是需要序列化的比特的数目还是<span>6</span>（注意看<code>WriteBits( writer, numElements, 6 )的6， 现在需要7了</code>）。哎呦。因为你忘记了在读取和写入函数里面更新比特的数目，那么现在当你在发送数据的时候你会把高位进行截断。事后追查这样的事情是相当困难的。</span></span><span style="font-family:微软雅黑;font-size:medium;"><span style="color: rgb(34, 34, 34);">让我们通过增加一些编译时候的检测来计算出所需要的比特的位数：</span> </span><div><div id="highlighter_404628" class="syntaxhighlighter  cpp"><div class="toolbar"><a class="toolbar_item command_help help">?</a></div><table cellpadding="0" cellspacing="0"><tr><br><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">uint32_t</span> x&gt; <span class="class"><span class="keyword">struct</span> <span class="title">PopCount</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">enum</span> &#123; a = x - ( ( x &gt;&gt; <span class="number">1</span> ) &amp; <span class="number">0x55555555</span> ),</span><br><span class="line">           b = ( ( ( a &gt;&gt; <span class="number">2</span> ) &amp; <span class="number">0x33333333</span> ) + ( a &amp; <span class="number">0x33333333</span> ) ),</span><br><span class="line">           c = ( ( ( b &gt;&gt; <span class="number">4</span> ) + b ) &amp; <span class="number">0x0f0f0f0f</span> ),</span><br><span class="line">           d = c + ( c &gt;&gt; <span class="number">8</span> ),</span><br><span class="line">           e = d + ( d &gt;&gt; <span class="number">16</span> ),</span><br><span class="line">    result = e &amp; <span class="number">0x0000003f</span> &#125;; </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">uint32_t</span> x&gt; <span class="class"><span class="keyword">struct</span> <span class="title">Log2</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">enum</span> &#123; a = x | ( x &gt;&gt; <span class="number">1</span> ),</span><br><span class="line">           b = a | ( a &gt;&gt; <span class="number">2</span> ),</span><br><span class="line">           c = b | ( b &gt;&gt; <span class="number">4</span> ),</span><br><span class="line">           d = c | ( c &gt;&gt; <span class="number">8</span> ),</span><br><span class="line">           e = d | ( d &gt;&gt; <span class="number">16</span> ),</span><br><span class="line">           f = e &gt;&gt; <span class="number">1</span>,</span><br><span class="line">    result = PopCount&lt;f&gt;::result &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">int64_t</span> min, <span class="keyword">int64_t</span> max&gt; <span class="class"><span class="keyword">struct</span> <span class="title">BitsRequired</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">uint32_t</span> result = </span><br><span class="line">        ( min == max ) ? <span class="number">0</span> : ( Log2&lt;<span class="keyword">uint32_t</span>(max-min)&gt;::result + <span class="number">1</span> );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BITS_REQUIRED( min, max ) BitsRequired<span class="meta-string">&lt;min,max&gt;::result</span></span></span><br></pre></td></tr></table></figure><br><br></tr></table></div></div><br><p style="margin: 6pt 0cm; line-height: 16.8pt; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial;"><span><br></span><span style="font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">哦，太好了。模板元编程和宏。感谢格伦！</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">但是这么做真的真棒，相信我！因为你现在没有办法弄乱需要的比特的数目了：</span> </p><div><div id="highlighter_849247" class="syntaxhighlighter  cpp"><div class="toolbar"><a class="toolbar_item command_help help">?</a></div><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp keyword bold">const</code> <code class="cpp color1 bold">int</code> <code class="cpp plain">MaxElements = 32;</code></div><div class="line number2 index1 alt1"><code class="cpp keyword bold">const</code> <code class="cpp color1 bold">int</code> <code class="cpp plain">MaxElementBits = BITS_REQUIRED( 0, MaxElements ); </code></div><div class="line number3 index2 alt2"> </div><div class="line number4 index3 alt1"><code class="cpp keyword bold">struct</code> <code class="cpp plain">PacketB</code></div><div class="line number5 index4 alt2"><code class="cpp plain">{</code></div><div class="line number6 index5 alt1"> </div><div class="line number7 index6 alt2"><code class="cpp spaces">    </code><code class="cpp color1 bold">int</code> <code class="cpp plain">numElements;</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">    </code><code class="cpp color1 bold">int</code> <code class="cpp plain">elements[MaxElements]; </code></div><div class="line number9 index8 alt2"> </div><div class="line number10 index9 alt1"><code class="cpp spaces">    </code><code class="cpp keyword bold">void</code> <code class="cpp plain">Write( BitWriter &amp; writer )</code></div><div class="line number11 index10 alt2"><code class="cpp spaces">    </code><code class="cpp plain">{</code></div><div class="line number12 index11 alt1"> </div><div class="line number13 index12 alt2"><code class="cpp spaces">        </code><code class="cpp plain">WriteBits( writer, numElements, MaxElementBits );</code></div><div class="line number14 index13 alt1"><code class="cpp spaces">        </code><code class="cpp keyword bold">for</code> <code class="cpp plain">( </code><code class="cpp color1 bold">int</code> <code class="cpp plain">i = 0; i &lt; numElements; ++i )</code></div><div class="line number15 index14 alt2"><code class="cpp spaces">            </code><code class="cpp plain">WriteBits( writer, elements[i], 32 );</code></div><div class="line number16 index15 alt1"><code class="cpp spaces">    </code><code class="cpp plain">}</code></div><div class="line number17 index16 alt2"> </div><div class="line number18 index17 alt1"><code class="cpp spaces">    </code><code class="cpp keyword bold">void</code> <code class="cpp plain">Read( BitReader &amp; reader )</code></div><div class="line number19 index18 alt2"><code class="cpp spaces">    </code><code class="cpp plain">{</code></div><div class="line number20 index19 alt1"> </div><div class="line number21 index20 alt2"><code class="cpp spaces">        </code><code class="cpp plain">ReadBits( reader, numElements, MaxElementBits );</code></div><div class="line number22 index21 alt1"><code class="cpp spaces">        </code><code class="cpp keyword bold">for</code> <code class="cpp plain">( </code><code class="cpp color1 bold">int</code> <code class="cpp plain">i = 0; i &lt; numElements; ++i )</code></div><div class="line number23 index22 alt2"><code class="cpp spaces">            </code><code class="cpp plain">ReadBits( buffer, elements[i], 32 );</code></div><div class="line number24 index23 alt1"><code class="cpp spaces">    </code><code class="cpp plain">}</code></div><div class="line number25 index24 alt2"><code class="cpp plain">};</code></div></div></td></tr></table></div></div><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222"> </span> </p><span style="color: rgb(34, 34, 34);"><span style="font-family:微软雅黑;font-size:medium;">当然现在也有机会犯错。<span>MaxElements</span>的值是<span>32</span>所以<span>BITS_REQUIRED(0,32) </span>返回的是<span>6</span>，因为<span>5</span>比特所能得到的取值范围只有【<span>0</span>，<span>31</span>】。这没什么问题，但是现在我们有概率把未定义的值进行插入，如果有一个恶意发送者发送了一个取值范围在【<span>33,63</span>】之间的值的话。当你在长度为<span>32</span>的数组里面读入<span>63</span>个整数的时候会发生什么？</span></span><span style="color: rgb(34, 34, 34);"><span style="font-family:微软雅黑;font-size:medium;">当然，你可以对取值范围进行限制来修正这个问题，但是仔细想想。。。如果你从位读取器得到了一个值但是它超出了取值范围，你要么就是让读取和写入操作完全不同步（这显然是你自己的错误）或者有人试图坑你。所以，不要对取值范围进行限制。如果遇到这种情况，直接停止对数据包的读取并且丢弃这个数据包。</span></span><span style="color: rgb(34, 34, 34);"><span style="font-family:微软雅黑;font-size:medium;">我还想在这里提到一个陷阱，因为这个陷阱看上去很方便，但是其实它会让代码运行的很慢。我有一次使用异常实现了数据包的读取中断。它看上去很棒，因为在一个递归的位打包器读取函数里面你可能会有<span>28</span>层调用堆栈，而你想要做的不过是展开堆栈然后回到数据包读取函数调用的地方，但是异常真的太慢太慢了。</span></span><span style="color: rgb(34, 34, 34);"><span style="font-family:微软雅黑;font-size:medium;">为了取代异常，有两种方法可以运行的快得多：<span>1)</span>在位读取器那里设置一个值表明这个数据包应该被丢弃，<span>2</span>）升级数据包的读取函数让它在读取失败的时候返回<span>false</span>。但是现在，你可以使用这里面的任意一种方法，为了实现读取时候的安全性，你需要检测上面说的标记或者在每一次读取的时候返回一个值，否则如果遇到读取失败的情况，你还是会一直继续读取直到把内存全部耗光。</span></span><div><div id="highlighter_168864" class="syntaxhighlighter  cpp"><div class="toolbar"><a class="toolbar_item command_help help">?</a></div><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp keyword bold">const</code> <code class="cpp color1 bold">int</code> <code class="cpp plain">MaxElements = 32;</code></div><div class="line number2 index1 alt1"><code class="cpp keyword bold">const</code> <code class="cpp color1 bold">int</code> <code class="cpp plain">MaxElementBits = BITS_REQUIRED( 0, MaxElements );</code></div><div class="line number3 index2 alt2"> </div><div class="line number4 index3 alt1"> </div><div class="line number5 index4 alt2"><code class="cpp keyword bold">struct</code> <code class="cpp plain">PacketB</code></div><div class="line number6 index5 alt1"><code class="cpp plain">{</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">    </code><code class="cpp color1 bold">int</code> <code class="cpp plain">numElements;</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">    </code><code class="cpp color1 bold">int</code> <code class="cpp plain">elements[MaxElements];</code></div><div class="line number9 index8 alt2"><code class="cpp spaces"> </code> </div><div class="line number10 index9 alt1"> </div><div class="line number11 index10 alt2"><code class="cpp spaces">    </code><code class="cpp keyword bold">void</code> <code class="cpp plain">Write( BitWriter &amp; writer )</code></div><div class="line number12 index11 alt1"><code class="cpp spaces">    </code><code class="cpp plain">{</code></div><div class="line number13 index12 alt2"><code class="cpp spaces">        </code><code class="cpp plain">WriteBits( writer, numElements, MaxElementBits );</code></div><div class="line number14 index13 alt1"><code class="cpp spaces">        </code><code class="cpp keyword bold">for</code> <code class="cpp plain">( </code><code class="cpp color1 bold">int</code> <code class="cpp plain">i = 0; i &lt; numElements; ++i )</code></div><div class="line number15 index14 alt2"><code class="cpp spaces">            </code><code class="cpp plain">WriteBits( writer, elements[i], 32 );</code></div><div class="line number16 index15 alt1"><code class="cpp spaces">    </code><code class="cpp plain">}</code></div><div class="line number17 index16 alt2"> </div><div class="line number18 index17 alt1"> </div><div class="line number19 index18 alt2"><code class="cpp spaces">    </code><code class="cpp keyword bold">void</code> <code class="cpp plain">Read( BitReader &amp; reader )</code></div><div class="line number20 index19 alt1"><code class="cpp spaces">    </code><code class="cpp plain">{</code></div><div class="line number21 index20 alt2"><code class="cpp spaces">        </code><code class="cpp plain">ReadBits( reader, numElements, MaxElementBits );</code></div><div class="line number22 index21 alt1"><code class="cpp spaces">        </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( numElements &gt; MaxElements )</code></div><div class="line number23 index22 alt2"><code class="cpp spaces">        </code><code class="cpp plain">{</code></div><div class="line number24 index23 alt1"><code class="cpp spaces">            </code><code class="cpp plain">reader.Abort();</code></div><div class="line number25 index24 alt2"><code class="cpp spaces">            </code><code class="cpp keyword bold">return</code><code class="cpp plain">;</code></div><div class="line number26 index25 alt1"><code class="cpp spaces">        </code><code class="cpp plain">}</code></div><div class="line number27 index26 alt2"> </div><div class="line number28 index27 alt1"><code class="cpp spaces">        </code><code class="cpp keyword bold">for</code> <code class="cpp plain">( </code><code class="cpp color1 bold">int</code> <code class="cpp plain">i = 0; i &lt; numElements; ++i )</code></div><div class="line number29 index28 alt2"><code class="cpp spaces">        </code><code class="cpp plain">{</code></div><div class="line number30 index29 alt1"><code class="cpp spaces">            </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( reader.IsOverflow() )</code></div><div class="line number31 index30 alt2"><code class="cpp spaces">                </code><code class="cpp keyword bold">break</code><code class="cpp plain">;</code></div><div class="line number32 index31 alt1"> </div><div class="line number33 index32 alt2"><code class="cpp spaces">            </code><code class="cpp plain">ReadBits( buffer, elements[i], 32 );</code></div><div class="line number34 index33 alt1"><code class="cpp spaces">        </code><code class="cpp plain">}</code></div><div class="line number35 index34 alt2"><code class="cpp spaces">    </code><code class="cpp plain">}</code></div><div class="line number36 index35 alt1"><code class="cpp plain">};</code></div></div></td></tr></table></div></div><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222"> </span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">但是这么做了以后，整个读取函数就开始变得非常的复杂，而且如果有什么地方你漏过了这些检查的话，你就把自己置于缓冲区溢出和无线循环这种危险的境地。你不会希望在写数据包读取函数的时候全部变成一个手动的过程，你肯定是希望这个过程是自动化的。因为这给了程序员太多犯错误的机会。</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">请继续关注下一篇文，在那篇文章里面我将向你展现如何使用<span>C++</span>来用非常简洁的方式实现。</span> </p><b><span style="font-size:12.0pt;line-height:240%;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222;font-weight:normal">这个系列的下一篇文章是《序列化策略》。</span> </b><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">在这个系列的下一篇文章，我将向你展示如何将读取和写入函数统一到一个单独的序列化函数里面，它可以在不增加任何运行时损耗的情况同时处理读取和写入。</span> </p><p class="MsoNormal" align="left" style="line-height: 16.8pt; vertical-align: baseline;"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">如果你觉得这篇文章有价值的话，请在<span>patreon</span>上支持我的写作，这样我会写的更快。你可以在<span>BSD 3.0</span>许可下访问到这篇文章里面的代码。非常感谢你的支持！</span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222"> </span> </p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222"> </span> </p><p class="MsoNormal" align="left" style="line-height: 18pt; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial;"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">【版权声明】</span> </p><p class="MsoNormal"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;;color:#222222">原文作者未做权利声明，视为共享知识产权进入公共领域，自动获得授权。</span> </p><p class="MsoNormal"><span style="font-size:12.0pt;font-family:&quot;微软雅黑&quot;,&quot;sans-serif&quot;"> </span> </p></div>                    <br>                


      


      

    
      <footer class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/GafferOnGames/" rel="tag"><i class="fa fa-tag"></i> GafferOnGames</a>
            
          </div>
        

        
        
        

        
          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
              
                <a href="/2017/02/10/kbe之ubuntu下的编译/" rel="next" title="kbe之ubuntu下的编译">
                  <i class="fa fa-chevron-left"></i> 
                  <p class="post-nav-pre-next-title">
                    kbe之ubuntu下的编译
                  </p> 
                </a>
              
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
              
                <a href="/2017/02/25/serialization_strategies/" rel="prev" title="构建游戏网络协议二之序列化策略">
                <p class="post-nav-pre-next-title">
                    构建游戏网络协议二之序列化策略
                </p> 
                <i class="fa fa-chevron-right"></i>
                </a>
              
            </div>
          </div>
        

        
        
      </footer>
      
    </div>
    
    
    

    

    

    

  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  

  <aside id="sidebar" class="sidebar">

    
      
        <div id="sidebar-dimmer"></div>
      
    

    <div class="sidebar-inner">
    
      <div class="sidebar-toggle-inside motion-element">
        <div class="sidebar-toggle-line-wrap">
          <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
          <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
          <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
        </div>
      </div>

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a href="/" class="site-author-image" rel="start" style="border:none">
            <img class="site-author-image" itemprop="image" src="/uploads/avatar.png" alt="no5ix">
          </a>
          <p class="site-author-name" itemprop="name">no5ix</p>
           
              <p class="site-description motion-element" itemprop="description">推荐使用Chrome/Firefox/Safari阅读本博客. 以前的老笔记将会一篇一篇慢慢整理为博客, 这既启发了他人, 也锻炼了自己的描述交流能力.</p>
          
        </div>

        <nav class="site-state motion-element">

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">13</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">257</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">97</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

          <div class="site-state-item site-state-about">
            <a href="/about/">
              <span class="site-state-item-about fa fa-fw fa-user"></span>
              <span class="site-state-item-name">关于</span>
            </a>
          </div>
          
        </nav>

        

        <div class="links-of-author motion-element">
          
          
          <!-- 网易云音乐 -->
            <!-- <div class="netease-cloud-music"> -->
              <!-- <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=280 height=110 src="//music.163.com/outchain/player?type=0&id=992743594&auto=0&height=90"></iframe> -->
            <!-- </div> -->
          <!-- 网易云音乐 -->

        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-block">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              友情链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://119.23.17.57" title="ksun的博客" target="_blank">ksun的博客</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://mp.weixin.qq.com/mp/homepage?__biz=MzU3MTUyNzg0NQ==&hid=1&sn=7a3ae61b7af714f75d68e7ae826a2d2c&scene=18#wechat_redirect" title="你有图么我有故事" target="_blank">你有图么我有故事</a>
                </li>
              
            </ul>
          </div>
        

        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#自我总结"><span class="nav-number">1.</span> <span class="nav-text">自我总结</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#原文"><span class="nav-number">2.</span> <span class="nav-text">原文</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#introduction"><span class="nav-number">2.1.</span> <span class="nav-text">Introduction</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#background"><span class="nav-number">2.2.</span> <span class="nav-text">Background</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#the-inefficiencies-of-text"><span class="nav-number">2.3.</span> <span class="nav-text">The Inefficiencies of Text</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#switching-to-a-binary-format"><span class="nav-number">2.4.</span> <span class="nav-text">Switching to a Binary Format</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#getting-started-with-a-binary-format"><span class="nav-number">2.5.</span> <span class="nav-text">Getting Started with a Binary Format</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#read-and-write-functions"><span class="nav-number">2.6.</span> <span class="nav-text">Read and Write Functions</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#bitpacking"><span class="nav-number">2.7.</span> <span class="nav-text">Bitpacking</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#writing-bits"><span class="nav-number">2.8.</span> <span class="nav-text">Writing Bits</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#reading-bits"><span class="nav-number">2.9.</span> <span class="nav-text">Reading Bits</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#beyond-bitpacking"><span class="nav-number">2.10.</span> <span class="nav-text">Beyond Bitpacking</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#译文"><span class="nav-number">3.</span> <span class="nav-text">译文</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#导论"><span class="nav-number">3.1.</span> <span class="nav-text">导论</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#对数据包的读取和写入"><span class="nav-number">3.2.</span> <span class="nav-text">对数据包的读取和写入</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#文本格式存在的问题"><span class="nav-number">3.3.</span> <span class="nav-text">文本格式存在的问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#切换成二进制格式"><span class="nav-number">3.4.</span> <span class="nav-text">切换成二进制格式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#如何开始使用二进制格式"><span class="nav-number">3.5.</span> <span class="nav-text">如何开始使用二进制格式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#读取和写入函数"><span class="nav-number">3.6.</span> <span class="nav-text">读取和写入函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#读取和写入函数存在的问题"><span class="nav-number">3.7.</span> <span class="nav-text">读取和写入函数存在的问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实现一个位打包器"><span class="nav-number">3.8.</span> <span class="nav-text">实现一个位打包器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#以位来写入数据包"><span class="nav-number">3.9.</span> <span class="nav-text">以位来写入数据包</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#以位来读取数据包"><span class="nav-number">3.10.</span> <span class="nav-text">以位来读取数据包</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#如何使位打包器更棒"><span class="nav-number">3.11.</span> <span class="nav-text">如何使位打包器更棒</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy;  2013 - 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">no5ix</span>
</div>



        

        
      </div>
    </footer>

    <!--
    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
      
        <span id="scrollpercent"><span>0</span>%</span>
      
    </div>
    -->

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/dist/jquery.fancybox.js?v=3.2.10"></script>


  




  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>


  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  

  <script type="text/javascript">

    var is_load_xml_finished = 0;

    var searchFunc = function (path, search_id, content_id) {
      // 0x00. environment initialization
      'use strict';

      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      // var datas = [];

      /* loading css1 : Dot Css Loader*/
      var DotLoader = "<div class='loader'>Loading...</div>";

      /* loading css2 : Pure Css Loader - Square */
      var SquareLoader = 
        "<div class='loader'>" +
          "<div class='square' ></div>" +
          "<div class='square'></div>" +
          "<div class='square last'></div>" +
          "<div class='square clear'></div>" +
          "<div class='square'></div>" +
          "<div class='square last'></div>" +
          "<div class='square clear'></div>" +
          "<div class='square '></div>" +
          "<div class='square last'></div>" +
        "</div>";

      var ProgressBar = 
          "<div class='progress-bar'>" +
            "<div class='progress-bar-charge'></div>" +
          "</div>";

      var str = "";
      var keywords = [];
      var temp_keyword = "";

      // 是否为第一个字母被键入的标志位
      var first_char_flag = 0;

      // 因为在移动设备上, 点击搜索之后会 scroll 到页面顶部, 所以需要记录之前的页面x, y坐标值, 以便于搜索完点击 close 按钮之后 scroll 回原来的页面坐标值.
      var last_page_x = 0;
      var last_page_y = 0;

      var local_search_tips = 
            "<span class='local-search-empty'>" + "第一次搜索可能较慢, 先思考一个经典算法问题, 跳台阶:" + "</span>" +
            "<span class='local-search-empty'>" + "一只青蛙一次可以跳上1级台阶，也可以跳上2级。求该青蛙跳上一个6级的台阶总共有多少种跳法?n级呢?" + "</span>";

      function CloseLocalSearch()
      {
        first_char_flag = 0;

        $('#local-search-input').val('');
        $('#local-search-close').hide();

        // $('.local-search-result-cls ul li').velocity('stop').velocity('transition.slideDownOut', 200);

        $('#' + content_id).attr("headroom_special_attr","true"); 
        
        if (isMobile())
        {
          // $('body').scrollTop(last_page_y);  // scrollTop 有兼容性问题
          scrollTo(last_page_x, last_page_y);

          $('#' + content_id).hide();
        }
        else
        {
          $('#' + content_id).velocity('stop').velocity( 'transition.bounceUpOut', 200 );
        }

        // $('#' + content_id).velocity('stop').velocity( isMobile() ? 'transition.fadeOut' : 'transition.bounceUpOut', {
        //   // delay: isMobile() ? 50 : 0,
        //   duration: isMobile() ? 500 : 200,
        //   // begin: function() { 
        //   //   if (isMobile())
        //   //   {
        //   //     $('body').scrollTop(last_page_y);
        //   //   } 
        //   // }
        //   complete: function () {
        //     if (isMobile())
        //     {
        //       if (last_page_y < 20000)
        //       {
        //         $('body').velocity('scroll', { offset: last_page_y+"px", duration: last_page_y < 10000 ? 1000 : 2000 });
        //       }
        //       else
        //       {
        //         $('body').scrollTop(last_page_y);
        //       }
        //       // $('body').velocity('scroll');

        //       // $('html,body').animate({
        //       //   scrollTop: last_page_y
        //       // },400);
        //       // $('body').velocity('transition.slideDownIn', 1000);
        //       // $('body').velocity('scroll', { offset: last_page_y+"px", duration: document.body.scrollHeight < 20000 ? 1500 : 3000 });
        //     }
        //   }
        // });
      }

      function handleSearch()
      {
        if (keywords.length <= 0) {
          return;
        }
        $resultContent.innerHTML = "";
        $('#local-search-close').show();

        // 0x04. perform local searching
        if (is_load_xml_finished == 0)
        {
          $resultContent.innerHTML = 
            "<ul class='local-search-empty-ul'>" + 
            local_search_tips +
            ProgressBar;
        }
        else
        {
          // Retrieve the object from local storage
          var xml_resp = retrieve_search_xml()

          xml_resp.forEach(function (data) {
          // datas.forEach(function (data) {
            var isMatch = true;
            var content_index = [];
            if (!data.title || data.title.trim() === '') {
              data.title = "Untitled";
            }
            var is_encrypted = data.encrypted.trim() == '1'
            var is_sensitive = CONFIG.local_search.sensitive_word && data_content.indexOf(CONFIG.local_search.sensitive_word) >= 0
            var orig_data_title = data.title.trim();
            var data_title = orig_data_title.toLowerCase();
            var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
            var data_content = orig_data_content.toLowerCase();
            var data_url = decodeURIComponent(data.url);
            var index_title = -1;
            var index_content = -1;
            var first_occur = -1;
            // only match artiles with not empty contents
            if (data_content !== '') {
              keywords.forEach(function (keyword, i) {
                index_title = data_title.indexOf(keyword);
                index_content = (is_sensitive || is_encrypted) ? -1 : data_content.indexOf(keyword);

                if (index_title < 0 && index_content < 0) {
                  isMatch = false;
                } else {
                  if (index_content < 0) {
                    index_content = 0;
                  }
                  if (i == 0) {
                    first_occur = index_content;
                  }
                  // content_index.push({index_content:index_content, keyword_len:keyword_len});
                }
              });
            } else {
              isMatch = false;
            }
            // 0x05. show search results
            if (isMatch) {
              var content = orig_data_content;
              if (first_occur >= 0) {
                var match_content = "";
                if (!is_sensitive && !is_encrypted)
                {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  match_content = content.substr(start, end);
                }

                // highlight all keywords
                var regS = "";
                if (match_content != "")
                {
                  keywords.forEach(function (keyword) {
                    regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<b class=\"search-keyword\">" + keyword + "</b>");
                    orig_data_title = orig_data_title.replace(regS, "<b class=\"search-keyword\">" + keyword + "</b>");
                  });
                }
                else
                {
                  keywords.forEach(function (keyword) {
                    regS = new RegExp(keyword, "gi");
                    orig_data_title = orig_data_title.replace(regS, "<b class=\"search-keyword\">" + keyword + "</b>");
                  });
                }
                str += "<li><a href='" + data_url + "' class='search-result-title' target='_blank'>" + orig_data_title + "</a>";
                str += "<p class=\"search-result\">" + match_content + "...</p>"
              }
              str += "</li>";
            }
          });

          str += "</ul>";
          if (str.indexOf('<li>') === -1) {
            return $resultContent.innerHTML = 
              "<ul class='local-search-empty-ul'><span class='local-search-empty'>找不到, 换个搜索关键字试一哈.<span></ul>";
          }
          $resultContent.innerHTML = str;
        }
      }

      $input.addEventListener('input', function () {
        // 0x03. parse query to keywords list
        str = '<ul class=\"search-result-list\">';
        temp_keyword = this.value.trim();
        if (temp_keyword.length <= 0) {
          CloseLocalSearch();
          return;
        }

        keywords = temp_keyword.toLowerCase().split(/[\s\-]+/);
        handleSearch();

        // 当用户键入第一个字母的时候的动画处理逻辑 : 
        // 当 first_char_flag 为 0 的时候, 
        // 要播放一个动画
        if (first_char_flag == 0)
        {
            // $('body').scrollTop(0);
          if (isMobile())
          {
            last_page_x = window.pageXOffset;
            last_page_y = window.pageYOffset;
            // $('body').scrollTop(0);
            scrollTo(0,0);

          }
          first_char_flag = 1;
          $('#' + content_id).removeAttr("headroom_special_attr");
          
          $('#' + content_id).velocity('stop').velocity('transition.slideDownIn', 300);

          $('.local-search-result-cls ul li').velocity('stop').velocity('transition.slideDownIn', 1000);
        }
      });


      var local_search_xml_data = localStorage.getItem('local_search_xml_data');
      if (!local_search_xml_data) {
        $.ajax({
          // 0x01. load xml file
          url: path,
          dataType: "xml",
          success: function (xmlResponse) {
            store_search_xml(xmlResponse);

            // setTimeout(function(){
            //   is_load_xml_finished = 1;

            //   handleSearch();
            //   $('.local-search-result-cls ul li').velocity('stop').velocity('transition.slideDownIn', 800);
            // }, 2000);
            
            // is_load_xml_finished = 1;

            handleSearch();
            $('.local-search-result-cls ul li').velocity('stop').velocity('transition.slideDownIn', 800);
          }
        });
      }

      $(document).on('click', '#local-search-close', function() {
        CloseLocalSearch();
      });

      $(document).keyup(function(event){
        switch(event.keyCode) {
          case 27:
            // alert("ESC");
            CloseLocalSearch();
        }
      });

      // $(document).on('blur', '#local-search-input', function(e) {
      //   // console.log(document.activeElement.getAttribute('class'));
        
      //   if (isMobile() == false)
      //   {
      //     CloseLocalSearch();
      //   }
      // });
    }

    function isMobile() {
      // console.log(document.body.clientWidth);
      return document.body.clientWidth < 768

      // var userAgent = window.navigator.userAgent;

      // var isiPad = userAgent.match(/iPad/i) !== null;
      // var mobileUA = [
      //   'iphone', 'android', 'phone', 'mobile',
      //   'wap', 'netfront', 'x11', 'java', 'opera mobi',
      //   'opera mini', 'ucweb', 'windows ce', 'symbian',
      //   'symbianos', 'series', 'webos', 'sony',
      //   'blackberry', 'dopod', 'nokia', 'samsung',
      //   'palmsource', 'xda', 'pieplus', 'meizu',
      //   'midp' ,'cldc' , 'motorola', 'foma',
      //   'docomo', 'up.browser', 'up.link', 'blazer',
      //   'helio', 'hosin', 'huawei', 'novarra',
      //   'coolpad', 'webos', 'techfaith', 'palmsource',
      //   'alcatel', 'amoi', 'ktouch', 'nexian',
      //   'ericsson', 'philips', 'sagem', 'wellcom',
      //   'bunjalloo', 'maui', 'smartphone', 'iemobile',
      //   'spice', 'bird', 'zte-', 'longcos',
      //   'pantech', 'gionee', 'portalmmm', 'jig browser',
      //   'hiptop', 'benq', 'haier', '^lct',
      //   '320x320', '240x320', '176x220'
      // ];
      // var pattern = new RegExp(mobileUA.join('|'), 'i');

      // return !isiPad && userAgent.match(pattern);
    }

    function store_search_xml(xmlResponse) {
        datas = $("entry", xmlResponse).map(function () {
          return {
            title: $("title", this).text(),
            content: $("content", this).text(),
            url: $("url", this).text(),
            encrypted: $("encrypted", this).text(),
          };
        }).get();
        // Put the object into storage
        localStorage.setItem('local_search_xml_data', JSON.stringify(datas));
        is_load_xml_finished = 1;

        console.log("store search.xml finished.");
    }

    function ajax_store_search_xml() {
      $.ajax({
        url: "/search.xml",
        dataType: "xml",
        success: function (xmlResponse) {
            store_search_xml(xmlResponse);
        }
      });
    }

    function retrieve_search_xml() {
        // Retrieve the object from local storage
        var retrievedObject = localStorage.getItem('local_search_xml_data');
        var xml_resp = JSON.parse(retrievedObject)
        return xml_resp
    }

    var getSearchFile = function(){
      var path = "/search.xml";
      var local_search_result_name = isMobile() ? "local-search-result-mobile" : "local-search-result-pc";
      searchFunc(path, 'local-search-input', local_search_result_name);
    }

    var local_search_xml_data = localStorage.getItem('local_search_xml_data');
    if (local_search_xml_data) {
      is_load_xml_finished = 1;
      console.log("load search.xml finished.");
    }
    var last_use_local_search_date = localStorage.getItem('last_use_local_search_date');
    var curDate = new Date();
    // 只有在 localStorage 没有 search.xml数据或者 距离上次使用local search已经超过一天了才去取search.xml
    // 节省流量
    if (last_use_local_search_date != curDate.getDate() || !local_search_xml_data) {
      // preload search.xml
      ajax_store_search_xml();
    }

    localStorage.setItem('last_use_local_search_date', curDate.getDate());
    

  </script>





  

  

  

  

  

  


  <script type="text/javascript" src="/lib/wobble_window/wobblewindow.js"> </script>
<script type="text/javascript" src="/js/src/custom.js"></script>
</body>
</html>


<!-- 页面点击小红心 -->





<script type="text/javascript" src="/js/src/headroom.js"></script> 

<!-- 代码块复制功能 -->
<script type="text/javascript" src="/js/src/clipboard-use.js"></script>
